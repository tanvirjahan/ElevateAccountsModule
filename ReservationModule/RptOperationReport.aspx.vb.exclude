

Imports System.IO
Imports System.Data
Imports System.Data.SqlClient
Imports ClosedXML.Excel
Imports System.Collections.Generic
Imports System.Net

Partial Class RptOperationReport
    Inherits System.Web.UI.Page

#Region "Global Declaration"
    Dim objUser As New clsUser
    Dim objUtils As New clsUtils
    Dim mySqlConn As SqlConnection
    Dim mySqlCmd As SqlCommand
    Dim myDataAdapter As SqlDataAdapter
    Dim mySqlReader As SqlDataReader
    Dim strSqlQry As String
    Dim document As New XLWorkbook
    Dim myds As New DataSet
#End Region
    '*** Danny 08/12/2018 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetAgentGroups(ByVal prefixText As String) As List(Of String)
        Dim strSqlQry As String = ""

        Dim myDS As New DataSet
        Dim agentnames As New List(Of String)
        Try
            strSqlQry = "select customergroupname,customergroupcode from customergroup  where  active=1 and  customergroupname like  '" & Trim(prefixText) & "%'"
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)
            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    agentnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("customergroupname").ToString(), myDS.Tables(0).Rows(i)("customergroupcode").ToString()))
                Next
            End If
            Return agentnames
        Catch ex As Exception
            Return agentnames
        End Try
    End Function
    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetHotelChain(ByVal prefixText As String) As List(Of String)
        Dim strSqlQry As String = ""

        Dim myDS As New DataSet
        Dim agentnames As New List(Of String)
        Try
            strSqlQry = "select hotelchainname,hotelchaincode from hotelchainmaster  where  active=1 and  hotelchainname like  '" & Trim(prefixText) & "%'"
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)
            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    agentnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("hotelchainname").ToString(), myDS.Tables(0).Rows(i)("hotelchaincode").ToString()))
                Next
            End If
            Return agentnames
        Catch ex As Exception
            Return agentnames
        End Try
    End Function
    '*** Danny 08/12/2018 <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

    '*** Danny Multiselect 26/12/2018
    Protected Sub chkApproved_CheckedChanged(ByVal sender As Object, ByVal e As EventArgs)

        Dim chkApproved As CheckBox = CType(sender, CheckBox)
        Dim gridViewRow As GridViewRow = CType(chkApproved.Parent.Parent, GridViewRow)
        ''Dim orderID As Integer = CInt(gv_ServiceClassifications.DataKeys(gridViewRow.RowIndex).Value)

        'changed by mohamed on 01/01/2019
        'Dim lbls As New Label
        'lbls = gridViewRow.FindControl("ServiceName")
        'If (lbls.Text.ToUpper = "Car Rental".ToUpper) Then
        '    If chkApproved.Checked = True Then
        '        chk_CarDelivery.Style.Add("display", "block")
        '        chk_CarPickup.Style.Add("display", "block")
        '    Else
        '        chk_CarDelivery.Style.Add("display", "none")
        '        chk_CarPickup.Style.Add("display", "none")

        '    End If
        'End If

        ''Dim approved As Boolean = chkApproved.Checked

    End Sub


#Region "Protected Sub gvSearchResult_RowCommand(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCommandEventArgs) Handles gvSearchResult.RowCommand"
    Protected Sub gv_ServiceClassifications_RowCommand(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCommandEventArgs) Handles gv_ServiceClassifications.RowCommand
        Try
            Dim strpop As String = ""
            If e.CommandName = "Chkbox" Then
                Dim sclschkwkdays As CheckBox

                sclschkwkdays = gv_ServiceClassifications.Rows(CType(e.CommandArgument.ToString, String)).FindControl("clschkwkdays")


            End If
        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("BookingTray.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
    End Sub
#End Region

    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetAgents(ByVal prefixText As String) As List(Of String)
        Dim strSqlQry As String = ""

        Dim myDS As New DataSet
        Dim agentnames As New List(Of String)
        Try
            strSqlQry = "select agentname,agentcode from agentmast  where  active=1 and  agentname like  '" & Trim(prefixText) & "%'"
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)
            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    agentnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("agentname").ToString(), myDS.Tables(0).Rows(i)("agentcode").ToString()))
                Next
            End If
            Return agentnames
        Catch ex As Exception
            Return agentnames
        End Try
    End Function
    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetHotels(ByVal prefixText As String) As List(Of String)
        Dim strSqlQry As String = ""

        Dim myDS As New DataSet
        Dim hotelnames As New List(Of String)
        Try
            strSqlQry = "select partyname,partycode from partymast  where  active=1 and  partyname like  '" & Trim(prefixText) & "%' order by partyname"
            'strSqlQry = "select partyname,partycode from partymast  where  active=1 and  partyname like  '" & Trim(prefixText) & "%' and sptypecode = (select option_selected  from reservation_parameters where param_id=458) 'changed by mohamed on 13/12/2018 as to show all the service supplier
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)
            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    hotelnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("partyname").ToString(), myDS.Tables(0).Rows(i)("partycode").ToString()))
                Next
            End If
            Return hotelnames
        Catch ex As Exception
            Return hotelnames
        End Try
    End Function

    Public Sub GetAllLocation()
        Dim strSqlQry As String = ""
        Dim myDS As New DataSet
        Dim dropoffs As New List(Of String)
        Try

            ' strSqlQry = " select  partycode,partyname from partymast  where active=1 and partyname like  '" & prefixText & "%' order by partyname "

            strSqlQry = "select  othtypcode ,othtypname from  othtypmast(nolock)  where active=1 AND othgrpcode in (select option_selected from reservation_parameters where param_id=1001) order by othtypname "

            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)


            gv_Location.DataSource = myDS
            gv_Location.DataBind()



        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("rptOperationReport.aspx", Server.MapPath("ErrorLog.txt"), ex.StackTrace.ToString, Session("GlobalUserName"))
        End Try
    End Sub

    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetLocation(ByVal prefixText As String) As List(Of String)

        Dim strSqlQry As String = ""
        Dim myDS As New DataSet
        Dim dropoffs As New List(Of String)
        Try
            If prefixText = " " Then
                prefixText = ""
            End If
            ' strSqlQry = " select  partycode,partyname from partymast  where active=1 and partyname like  '" & prefixText & "%' order by partyname "

            strSqlQry = "select  othtypcode ,othtypname from  othtypmast(nolock)  where active=1 AND othgrpcode in (select option_selected from reservation_parameters where param_id=1001) AND othtypname like '%" & prefixText & "%' order by othtypname "

            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)

            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    dropoffs.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("othtypname").ToString(), myDS.Tables(0).Rows(i)("othtypcode").ToString()))
                    'Hotelnames.Add(myDS.Tables(0).Rows(i)("partyname").ToString() & "<span style='display:none'>" & i & "</span>")
                Next

            End If

            Return dropoffs
        Catch ex As Exception
            Return dropoffs
        End Try

    End Function
    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetService(ByVal prefixText As String) As List(Of String)
        Dim strSqlQry As String = ""

        Dim myDS As New DataSet
        Dim hotelnames As New List(Of String)
        Try
            strSqlQry = "SELECT ServiceCode,ServiceName FROM TB_Service WHERE ServiceNameType='MAIN'"
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)
            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    hotelnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("ServiceName").ToString(), myDS.Tables(0).Rows(i)("ServiceCode").ToString()))
                Next
            End If
            Return hotelnames
        Catch ex As Exception
            Return hotelnames
        End Try
    End Function

    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetSupplier(ByVal prefixText As String) As List(Of String)
        Dim strSqlQry As String = ""

        Dim myDS As New DataSet
        Dim hotelnames As New List(Of String)
        Try
            strSqlQry = "SELECT partycode,partyname FROM partymast active=1"
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)
            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    hotelnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("ServiceName").ToString(), myDS.Tables(0).Rows(i)("ServiceCode").ToString()))
                Next
            End If
            Return hotelnames
        Catch ex As Exception
            Return hotelnames
        End Try
    End Function

    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetClassification(ByVal prefixText As String) As List(Of String)

        Dim strSqlQry As String = ""
        Dim myDS As New DataSet
        Dim Hotelnames As New List(Of String)
        Try
            If prefixText = " " Then
                prefixText = ""
            End If
            strSqlQry = "select classificationcode,classificationname from excclassification_header(nolock) where active=1 and classificationname like  '" & prefixText & "%' order by classificationname "
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)

            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    Hotelnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("classificationname").ToString(), myDS.Tables(0).Rows(i)("classificationcode").ToString()))
                    'Hotelnames.Add(myDS.Tables(0).Rows(i)("partyname").ToString() & "<span style='display:none'>" & i & "</span>")
                Next

            End If

            Return Hotelnames
        Catch ex As Exception
            Return Hotelnames
        End Try

    End Function

#Region "Protected Sub Page_Load(sender As Object, e As System.EventArgs) Handles Me.Load"
    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If IsPostBack = False Then
            Try
                txtFromDate.Text = Date.Now
                txtToDate.Text = Date.Now.AddMonths(4).AddDays(-(DateTime.Now.Date.Day))

                txtBookingFromDate.Text = Date.Now
                txtBookingToDate.Text = Date.Now

                txtServiceModifyFromDate.Text = Date.Now
                txtServiceModifyToDate.Text = Date.Now

                If CType(Session("GlobalUserName"), String) = "" Or CType(Session("Userpwd"), String) = Nothing Then
                    Response.Redirect("~/Login.aspx", False)
                    Exit Sub
                End If
                Dim strappid As String = ""
                Dim strappname As String = ""

                Dim AppName As HiddenField = CType(Master.FindControl("hdnAppName"), HiddenField)
                Dim AppId As HiddenField = CType(Master.FindControl("hdnAppId"), HiddenField)

                If AppId.Value Is Nothing = False Then
                    strappid = AppId.Value
                End If
                strappname = objUser.GetAppName(Session("dbconnectionName"), strappid)


                objUser.CheckUserRight(Session("dbconnectionName"), CType(Session("GlobalUserName"), String), CType(Session("Userpwd"), String), _
                               CType(strappname, String), "ReservationModule\rptOperationReport.aspx", btnAddNew, btnExportToExcel, _
                               btnprint, gvSearch:=gvSearchResult)
                GetAllLocation()

                'objUtils.FillDropDownListWithValuenew(Session("dbconnectionName"), ddldivisions, "division_master_des", "division_master_code", "select division_master_code,division_master_des from division_master  order by division_master_code", True)
                'Dim showgroup As String = objUtils.ExecuteQueryReturnStringValuenew(Session("dbconnectionName"), "select option_selected  from reservation_parameters(nolock) where param_id=3001")
                'ddldivisions.Items.RemoveAt(ddldivisions.Items.Count - 1)
                'ddldivisions.Items.Add(New ListItem("All", "-1"))
                'ddldivisions.SelectedIndex = ddldivisions.Items.Count - 1
                'chkflightonly.Checked = True
                'chkshiftingonly.Checked = True

                chk_CarDelivery.Style.Add("display", "block")
                chk_CarPickup.Style.Add("display", "block")

                objUtils.FillDropDownListWithValuenew(Session("dbconnectionName"), ddlBookingStatusManual, "BsName", "BsCode", "select bsCode, BsName from booking_confirmation_statusdropdown order by seqno", True) 'changed by mohamed on 25/02/2019
            Catch ex As Exception
                ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
                objUtils.WritErrorLog("rptOperationReport.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
            End Try
        End If
    End Sub
#End Region
    Protected Sub btn_ServiceName_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btn_ServiceName.Click
        Dim strSqlQry As String = ""
        Dim myDS As New DataSet
        Dim Hotelnames As New List(Of String)
        Try
            If AutoCompleteExtender_Txt_ServiceName.ContextKey IsNot Nothing Then
                If AutoCompleteExtender_Txt_ServiceName.ContextKey <> Txt_ServiceCode.Text Then
                    Txt_ServiceName.Text = ""
                    Txt_ServiceName_code.Text = ""
                End If
            Else
                Txt_ServiceName.Text = ""
                Txt_ServiceName_code.Text = ""
            End If
            AutoCompleteExtender_Txt_ServiceName.ContextKey = Txt_ServiceCode.Text
            ddl_ServiceClassifications.DataSource = Nothing
            ddl_ServiceClassifications.DataBind()

            If (Txt_ServiceCode.Text.ToUpper = "Tours".ToUpper) Or (Txt_ServiceCode.Text.ToUpper = "ALL".ToUpper) Or Txt_ServiceCode.Text.Trim = "" Then
                chk_CarDelivery.Style.Add("display", "block")
                chk_CarPickup.Style.Add("display", "block")
            Else
                chk_CarDelivery.Style.Add("display", "none")
                chk_CarPickup.Style.Add("display", "none")
            End If

            If (Txt_ServiceCode.Text.ToUpper = "ALL".ToUpper) Or Txt_ServiceCode.Text.Trim = "" Then
                gv_ServiceClassifications.DataSource = Nothing
                gv_ServiceClassifications.DataBind()
                Exit Sub
            ElseIf (Txt_ServiceCode.Text.ToUpper = "AirportMA".ToUpper) Then
                strSqlQry = "SELECT ServiceCode,ServiceName FROM TB_Service WHERE ServiceNameType='AIRPORT'"
            ElseIf (Txt_ServiceCode.Text.ToUpper = "Transfer".ToUpper) Then
                strSqlQry = "SELECT ServiceCode,ServiceName FROM TB_Service WHERE ServiceNameType='TRANSFER'"
            ElseIf (Txt_ServiceCode.Text.ToUpper = "Tours".ToUpper) Then
                strSqlQry = "select classificationcode ServiceCode,classificationname ServiceName from excclassification_header(nolock)"
            ElseIf (Txt_ServiceCode.Text.ToUpper = "Others".ToUpper) Then
                strSqlQry = "select othgrpcode ServiceCode,othgrpname ServiceName  from  othgrpmast(nolock) where active=1 and othgrpcode not in (select othgrpcode from view_system_othgrp(nolock)) order by othgrpname "
            ElseIf (Txt_ServiceCode.Text.ToUpper = "Visa".ToUpper) Then
                strSqlQry = " select othtypcode ServiceCode,othtypname ServiceName from othtypmast where othgrpcode=(select option_selected from reservation_parameters where param_id=1002)"
            ElseIf (Txt_ServiceCode.Text.ToUpper = "Hotel".ToUpper) Then
                strSqlQry = " select catcode ServiceCode, catname ServiceName from view_hotel_category(nolock) order by rankorder"
            ElseIf (Txt_ServiceCode.Text.ToUpper = "TRANSFER,TOURS".ToUpper) Then '*** Danny 22/02/2019
                gv_ServiceClassifications.DataSource = Nothing
                gv_ServiceClassifications.DataBind()
                Exit Sub

            End If
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            If strSqlQry.Length > 0 Then
                myDataAdapter.Fill(myDS)
                gv_ServiceClassifications.DataSource = Nothing
                gv_ServiceClassifications.DataBind()


                gv_ServiceClassifications.DataSource = myDS
                gv_ServiceClassifications.DataBind()
            End If

        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("rptOperationReport.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try

    End Sub
    Private Function TopHeadings(ByVal ws As IXLWorksheet, ByRef LineNo As Integer) As IXLWorksheet
        Dim header As IXLRange
        ''***LineNo=2
        header = ws.Range("A" + LineNo.ToString + ":R" + LineNo.ToString)  '*** Danny 07/12/2018 'V to W changed by mohamed on 13/12/2018
        header.Style.Font.SetBold()
        header.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#e2efda"))
        header.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        header.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        header.Merge()
        header.Style.Font.FontSize = 16

        Dim headertext As Object
        headertext = ws.Ranges("e" + LineNo.ToString + ":R" + LineNo.ToString) '*** Danny 07/12/2018 
        headertext.Style.Font.SetBold()
        headertext.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        headertext.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        headertext.Style.Font.SetBold()
        headertext.Style.Font.FontSize = 16
        headertext.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        headertext.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)

        Dim range1 As IXLRange
        range1 = ws.Range("e" + LineNo.ToString + ":R" + LineNo.ToString) '*** Danny 07/12/2018 
        range1.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range1.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        range1.Merge()
        range1.Value = CType(Session("CompanyName"), String)
        range1.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        range1.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)



        LineNo += 1
        Dim header2 As IXLRange
        header2 = ws.Range("A" + LineNo.ToString + ":R" + LineNo.ToString)  '*** Danny 07/12/2018 'V to W changed by mohamed on 13/12/2018
        header2.Style.Font.SetBold()
        header2.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#FFE5CC"))
        header2.Merge()
        header2.Style.Font.FontSize = 14

        Dim headertext2 As Object
        headertext2 = ws.Ranges("e" + LineNo.ToString + ":h" + LineNo.ToString)
        headertext2.Style.Font.SetBold()
        headertext2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        headertext2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)

        Dim range2 As IXLRange
        range2 = ws.Range("e" + LineNo.ToString + ":M" + LineNo.ToString) 'changed by mohamed on 09/12/2018 to h to j
        Dim multiline As Object
        multiline = String.Concat("Operations List for Date " & IIf(txtFromDate.Text = txtToDate.Text, "", "range ") & ": " + txtFromDate.Text + IIf(txtFromDate.Text = txtToDate.Text, "", " - " & txtToDate.Text)) 'changed by mohamed on 09/12/2018
        range2.Value = multiline
        range2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        range2.Merge()



        Return ws
    End Function
    Private Function FilterTextHeading(ByVal ws As IXLWorksheet, ByRef LineNo As Integer, ByVal strclassificationName As String) As IXLWorksheet
        Dim repfilter As New StringBuilder
        LineNo = LineNo + 1
        ws.Cell(LineNo, 1).Value = repfilter
        If Txt_BookinNo.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append("Booking No: " & Txt_BookinNo.Text & "")
        End If
        If Txt_OldBookinRef.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" Old Ref: " & Txt_OldBookinRef.Text & "")
        End If
        If Txt_AgentRef.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" Agent Ref: " & Txt_AgentRef.Text & "")
        End If
        If ddlServiceName.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" Service: " & ddlServiceName.Text & "")
        End If
        If strclassificationName.Trim <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" , Service Classification : " & strclassificationName.Trim & "")
        End If
        If Txt_LocationName.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" , Location : " & Txt_LocationName.Text & "")
        End If
        If TxtHotelName.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" , Supplier : " & TxtHotelName.Text & "")
        End If
        If TxtAgentName.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" , Agent : " & TxtAgentName.Text & "")
        End If
        If Txt_AirportName.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" , Airports : " & Txt_AirportName.Text & "")
        End If
        If TxtFlightName.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(",  Flight :  " & TxtFlightName.Text & "")
        End If
        If ddlBookingStatus.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(",  Service Status :  " & ddlBookingStatus.Text & "")
        End If
        If ddlBookingStatusManual.Text <> "" Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(",  Booking Status :  " & ddlBookingStatusManual.Text & "")
        End If

        If chk_SelfDrive.Checked = True Then
            ws.Cell(LineNo, 1).Value = repfilter.Append(" , Self Drive: YES")
        Else
            'ws.Cell(LineNo, 1).Value = repfilter.Append(" , Self Drive: NO")
        End If
        ws.Range(LineNo, 1, LineNo, 18).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(LineNo, 1, LineNo, 18).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018



        Return ws
    End Function
    Private Function ExcelCreateCarRental(ByVal ws As IXLWorksheet, ByRef LineNo As Integer, ByVal strclassificationName As String) As IXLWorksheet



        'ws.Range(LineNo, 1, 4, 23).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)

        'trow = 5

        'ws.Column("A").Width = 16
        'ws.Column("B").Width = 16 'changed by mohamed on 02/01/2019 '13
        'ws.Column("C").Width = 10
        'ws.Column("D").Width = 10
        'ws.Column("E").Width = 22
        'ws.Column("F").Width = 4 'changed by mohamed on 02/01/2019 '8
        'ws.Column("G").Width = 8
        'ws.Column("H").Width = 4 'changed by mohamed on 02/01/2019 '10
        'ws.Column("I").Width = 14
        'ws.Column("J").Width = 11
        'ws.Column("K").Width = 8
        'ws.Column("L").Width = 16 'changed by mohamed on 02/01/2019 '8
        'ws.Column("M").Width = 11
        'ws.Column("N").Width = 8
        'ws.Column("O").Width = 16 'changed by mohamed on 02/01/2019 '14
        'ws.Column("P").Width = 14
        'ws.Column("Q").Width = 13 'changed by mohamed on 02/01/2019 '8
        'ws.Column("R").Width = 16 '*** Danny 07/12/2018 
        ' ws.Column("Q").Width = 11
        'ws.Column("t").Width = 10
        'ws.Column("U").Width = 11
        'ws.Column("V").Width = 25

        'Dim title = ws.Range(LineNo, 1, trow, 24)

        'Dim bookingtitle = ws.Range(LineNo, 1, trow, 24).Style.Font.SetBold()
        'ws.Range(LineNo, 1, trow, 22).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        'ws.Range(LineNo, 1, trow, 22).Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        'bookingtitle.Alignment.WrapText = True
        Dim intColno As Integer = 1
        LineNo += 1
        ws.Cell(LineNo, intColno).Value = "Agent"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Booking No."
        intColno = intColno + 1
        'ws.Cell(LineNo, intColno).Value = "Old Booking Ref"
        'intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Service Date"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Classification"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Guest Name"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "STS" 'changed by mohamed on 02/01/2019 '"Status"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Created By"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "PAX" 'changed by mohamed on 02/01/2019 '"Adult" + vbCr + "Child" + vbCr + "Total Pax"
        intColno = intColno + 1
        'ws.Cell(LineNo, intColno).Value =
        'intColno = intColno + 1
        'ws.Cell(LineNo, intColno).Value =
        'intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Car Details"
        intColno = intColno + 1
        'ws.Cell(LineNo, intColno).Value = "Delivery Date"
        'intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Delivery Time"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Delivery Hotel"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Drop Off Date"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Drop Off Time"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Drop Off Hotel"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Supplier"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Service Remarks"
        intColno = intColno + 1 '*** Danny 07/12/2018 
        ws.Cell(LineNo, intColno).Value = "Old Ref"
        intColno = intColno + 1  '*** Danny 11/12/2018 
        ws.Cell(LineNo, intColno).Value = "ServiceAddModDate"

        'ws.Cell(LineNo, 4).Value = "CheckOut"
        'ws.Cell(LineNo, 7).Value = "Service Type"
        'ws.Cell(LineNo, 10).Value = "Pick Up Time"
        'ws.Cell(LineNo, 11).Value = "FlightNo"
        'ws.Cell(LineNo, 12).Value = "Flight Time"
        'ws.Cell(LineNo, 13).Value = "Pick Up"
        'ws.Range(LineNo - 1, 1, LineNo - 1, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        'ws.Range(LineNo - 1, 1, LineNo - 1, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018

        ws.Range(LineNo, 1, LineNo, intColno).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)

        Dim title = ws.Range(LineNo, 1, LineNo, intColno)

        Dim bookingtitle = ws.Range(LineNo, 1, LineNo, intColno).Style.Font.SetBold()
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        bookingtitle.Alignment.WrapText = True

        ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin)
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin)
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)



        LineNo = LineNo + 1
        If myds.Tables(0).Rows.Count >= 0 Then
            Dim dvMyTable As DataView
            dvMyTable = New DataView(myds.Tables(0))
            dvMyTable.RowFilter = "SERVICETYPE='TOURS'"

            For Each bookingdetail In dvMyTable.ToTable.Rows
                title = ws.Range(++LineNo, 1, LineNo, intColno - 4) '*** Danny 07/12/2018 
                title.Style.Alignment.WrapText = True

                intColno = 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("agentname")
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = "New: " & bookingdetail("requestid") + vbCr + "Old: " & bookingdetail("columbusref") 'changed by mohamed on 02/01/2019
                ws.Cell(LineNo, intColno).Value = bookingdetail("requestid") '*** Danny 07/12/2018 
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = bookingdetail("columbusref")
                'intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = (CType(bookingdetail("servicedate"), Date))
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("classification")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("GuestName")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("bookingStatus")
                intColno = intColno + 1
                If bookingdetail("CreatedBy").ToString.Contains(" ") Then 'changed by mohamed on 02/01/2019
                    ws.Cell(LineNo, intColno).Value = Left(bookingdetail("CreatedBy"), InStr(bookingdetail("CreatedBy"), " ") - 1)
                Else
                    ws.Cell(LineNo, intColno).Value = bookingdetail("CreatedBy")
                End If

                intColno = intColno + 1

                ws.Cell(LineNo, intColno).Value = bookingdetail("Adult").ToString & IIf(bookingdetail("Child").ToString = "" Or bookingdetail("Child").ToString = "0", "", "+" & bookingdetail("Child").ToString)

                intColno = intColno + 1

                ws.Cell(LineNo, intColno).Value = bookingdetail("servicename")
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = bookingdetail("carrentalDeliveryDate")
                'intColno = intColno + 1
                If (bookingdetail("carrentalDeliveryDate").ToString.Trim.Length > 0) Then
                    Dim lbNeedDateToPrint As Boolean
                    lbNeedDateToPrint = False
                    Dim lsCarDeliveryDate As Date
                    Dim lsCarServiceDate As Date
                    Try
                        If IsDate(bookingdetail("carrentalDeliveryDate")) Then
                            lsCarDeliveryDate = CType(bookingdetail("carrentalDeliveryDate"), Date)
                            lsCarServiceDate = CType(bookingdetail("servicedate"), Date)
                            If lsCarDeliveryDate <> lsCarServiceDate Then
                                lbNeedDateToPrint = True
                            End If
                        End If
                    Catch ex As Exception

                    End Try
                    If lbNeedDateToPrint = True Then 'If ((CType(bookingdetail("carrentalDeliveryDate"), String)) <> (CType(bookingdetail("servicedate"), String))) Then
                        ws.Cell(LineNo, intColno).Value = bookingdetail("carrentalDeliveryDate") + " - " + bookingdetail("carrentalDeliveryTime")
                    Else
                        ws.Cell(LineNo, intColno).Value = "'" & bookingdetail("carrentalDeliveryTime")
                    End If
                Else
                    ws.Cell(LineNo, intColno).Value = "'" & bookingdetail("carrentalDeliveryTime")
                End If



                'ws.Cell(LineNo, intColno).Value = bookingdetail("carrentalDeliveryDate")
                'intColno = intColno + 1

                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("carrentalDeliveryPlace")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("carrentalPickupDate")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = "'" & bookingdetail("carrentalPickupTime")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("carrentalPickupPlace")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("partyname")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = "BD:" & bookingdetail("bookingdate") + vbCr + bookingdetail("ServiceRemark")
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = (CType(bookingdetail("bookingdate"), Date))
                ws.Cell(LineNo, intColno).Value = bookingdetail("columbusref") '*** Danny 07/12/2018 
                intColno = intColno + 1 '*** Danny 11/12/2018 
                ws.Cell(LineNo, intColno).Value = bookingdetail("ServiceAddModDate")



                'ws.Cell(LineNo, intColno).Value = bookingdetail("checkout")
                'intColno = intColno + 1


                'ws.Cell(LineNo, intColno).Value = bookingdetail("servicetype")
                'intColno = intColno + 1


                'ws.Cell(LineNo, intColno).Value = bookingdetail("pickuptime")
                'intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = bookingdetail("flightno")
                'intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = bookingdetail("flighttime")
                'intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = bookingdetail("pickup")
                'intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = bookingdetail("dropoff")
                'intColno = intColno + 1
                ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
                ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)

                ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018

                LineNo = LineNo + 1
            Next

        End If
        'ws = PageSizeSet(ws, LineNo, "S", intColno, True) '*** Danny 31/01/2019
        ''ws.Range("D1:D" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ''ws.Range("H1:H" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ''ws.Range("F1:F" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018
        ''ws.Range("K1:K" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ''ws.Range("N1:N" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 


        Return ws
    End Function
    Private Function ExcelCreateTransfer(ByVal ws As IXLWorksheet, ByRef LineNo As Integer, ByVal strclassificationName As String) As IXLWorksheet

        ''ws = TopHeadings(ws, LineNo)
        'LineNo += 1
        'Dim repfilter As New StringBuilder
        'ws.Cell(LineNo, 1).Value = repfilter
        'If Txt_BookinNo.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append("Booking No: " & Txt_BookinNo.Text & "")
        'End If
        'If Txt_OldBookinRef.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" Old Ref: " & Txt_OldBookinRef.Text & "")
        'End If
        'If Txt_AgentRef.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" Agent Ref: " & Txt_AgentRef.Text & "")
        'End If
        'If ddlServiceName.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" Service: " & ddlServiceName.Text & "")
        'End If
        'If strclassificationName.Trim <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" , Service Classification : " & strclassificationName.Trim & "")
        'End If
        'If Txt_LocationName.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" , Location : " & Txt_LocationName.Text & "")
        'End If
        'If TxtHotelName.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" , Supplier : " & TxtHotelName.Text & "")
        'End If
        'If TxtAgentName.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" , Agent : " & TxtAgentName.Text & "")
        'End If
        'If Txt_AirportName.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" , Airports : " & Txt_AirportName.Text & "")
        'End If
        'If TxtFlightName.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(",  Flight :  " & TxtFlightName.Text & "")
        'End If
        'If ddlBookingStatus.Text <> "" Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(",  Booking Status :  " & ddlBookingStatus.Text & "")
        'End If

        'If chk_SelfDrive.Checked = True Then
        '    ws.Cell(LineNo, 1).Value = repfilter.Append(" , Self Drive: YES")
        'Else
        '    'ws.Cell(LineNo, 1).Value = repfilter.Append(" , Self Drive: NO")
        'End If

        ''trow = LineNo

        'ws.Column("A").Width = 16 'Agent
        'ws.Column("B").Width = 16 'changed by mohamed on 02/01/2019 '13 'Booking No.
        ''ws.Column("C").Width = 11  'Service Date
        'ws.Column("D").Width = 5  'changed by mohamed on 02/01/2019 'Commented 'Service
        'ws.Column("E").Width = 22 'Guest Name
        'ws.Column("F").Width = 4 'changed by mohamed on 02/01/2019 'Commented 'Status
        ''ws.Column("G").Width = 4 'changed by mohamed on 02/01/2019 'Commented 'Created By


        'ws.Column("H").Width = 4 'changed by mohamed on 02/01/2019 'Commented 'Pax

        'ws.Column("M").Width = 18 'changed by mohamed on 02/01/2019 'Commented 'Pick up
        'ws.Column("N").Width = 18 'changed by mohamed on 02/01/2019 'Commented 'Drop Off
        'ws.Column("O").Width = 16 'changed by mohamed on 02/01/2019 'Commented 'Supplier
        'ws.Column("P").Width = 13 'changed by mohamed on 02/01/2019 'Commented '8 'Remarks
        'ws.Column("Q").Width = 11
        'ws.Column("R").Width = 11


        Dim intColno As Integer = 1
        ws.Cell(LineNo, intColno).Value = "Agent"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Booking No."
        intColno = intColno + 1
        'ws.Cell(LineNo, 2).Value = "Old Booking Ref"
        ws.Cell(LineNo, intColno).Value = "Service Date"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "TRF" 'changed by mohamed on 02/01/2019 '"Classification"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Guest Name"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "STS" 'changed by mohamed on 02/01/2019 '"Status"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Created By"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "PAX" 'changed by mohamed on 02/01/2019 '"Adult" + vbCr + "Child" + vbCr + "Total Pax" 
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Car Type"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "FlightNo"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Flight Time"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Pick Up Time"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Pick Up"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Drop Off"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Supplier/Driver"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Service Remarks"
        intColno = intColno + 1
        ws.Cell(LineNo, intColno).Value = "Old Ref"        '*** Danny 07/12/2018 
        intColno = intColno + 1  '*** Danny 11/12/2018 
        ws.Cell(LineNo, intColno).Value = "ServiceAddModDate"


        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        'ws.Cell(LineNo, 23).Value = "Consultant Name" 'changed by mohamed on 13/12/2018
        'ws.Cell(4, 1).Value = repfilter.Append(" , Group By:  " & GroupBy.SelectedItem.Text & "  , Division:  " & ddldivisions.SelectedItem.Text & "")

        ws.Range(LineNo, 1, LineNo, intColno).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left) '17 to 23 changed by mohamed on 13/12/2018
        Dim bookingtitle = ws.Range(LineNo, 1, LineNo, intColno).Style.Font.SetBold()
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        bookingtitle.Alignment.WrapText = True

        Dim title = ws.Range(LineNo, 1, LineNo, intColno)

        ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018



        LineNo = LineNo + 1
        If myds.Tables(0).Rows.Count >= 0 Then
            Dim dvMyTable As DataView
            dvMyTable = New DataView(myds.Tables(0))
            dvMyTable.RowFilter = "SERVICETYPE='TRANSFER'"

            For Each bookingdetail In dvMyTable.ToTable.Rows
                title = ws.Range(++LineNo, 1, LineNo, intColno - 3)   '*** Danny 11/12/2018 
                title.Style.Alignment.WrapText = True

                intColno = 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("agentname")
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = "New: " + bookingdetail("requestid") + vbCr + "Old: " + bookingdetail("columbusref") 'changed by mohamed on 02/01/2019
                ws.Cell(LineNo, intColno).Value = bookingdetail("requestid")   '*** Danny 07/12/2018 
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = bookingdetail("columbusref")
                'intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = (CType(bookingdetail("servicedate"), Date))
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = Left(bookingdetail("classification"), 3)
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("GuestName")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("bookingStatus")
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = bookingdetail("checkout")
                'intColno = intColno + 1
                If bookingdetail("CreatedBy").ToString.Contains(" ") Then 'changed by mohamed on 02/01/2019
                    ws.Cell(LineNo, intColno).Value = Left(bookingdetail("CreatedBy"), InStr(bookingdetail("CreatedBy"), " ") - 1)
                Else
                    ws.Cell(LineNo, intColno).Value = bookingdetail("CreatedBy")
                End If
                intColno = intColno + 1

                'changed by mohamed on 02/01/2019
                ws.Cell(LineNo, intColno).Value = bookingdetail("Adult").ToString & IIf(bookingdetail("Child").ToString = "" Or bookingdetail("Child").ToString = "0", "", "+" & bookingdetail("Child").ToString)
                'ws.Cell(LineNo, intColno).Value = "Adult: " + bookingdetail("Adult").ToString + vbCr + "Child: " + bookingdetail("Child").ToString + vbCr + "Total: " + bookingdetail("TotalPax").ToString

                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("transfercartype")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("flightno")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = "'" & bookingdetail("flighttime")
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = "Tour Language"
                'intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = "'" & bookingdetail("pickuptime")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("pickup")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("dropoff")
                intColno = intColno + 1
                'ws.Cell(LineNo, intColno).Value = "Drop Off Hotel"
                'intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("partyname")
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = "BD:" & bookingdetail("bookingdate") & vbCr & bookingdetail("ServiceRemark") 'changed by mohamed on 02/01/2019
                intColno = intColno + 1
                ws.Cell(LineNo, intColno).Value = bookingdetail("columbusref")   '*** Danny 07/12/2018 
                intColno = intColno + 1 '*** Danny 11/12/2018 
                ws.Cell(LineNo, intColno).Value = bookingdetail("ServiceAddModDate")



                ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
                ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
                'changed by mohamed on 13/12/2018
                ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(LineNo, 1, LineNo, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018

                LineNo = LineNo + 1
            Next

        End If
        'ws = PageSizeSet(ws, trow, "P", intColno, True) '*** Danny 31/01/2019
        'ws = PageSizeSet(ws, LineNo, "R", intColno, True) '*** Danny 31/01/2019
        'ws.Range("D1:D" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        'ws.Range("H1:H" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        'ws.Range("F1:F" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018
        'ws.Range("K1:K" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        'ws.Range("L1:L" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        Return ws
    End Function
    '*** Danny Multiselect 26/02/2019
    Private Sub TransferAndCarRental(ByVal strclassificationName As String)
        If myds.Tables(0).Rows.Count = 0 Then
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('No result found!' );", True)
            Exit Sub
        End If
        Dim trow As Integer = 3
        Dim wb As New XLWorkbook

        Dim FolderPath As String = "..\ExcelTemp\"
        Dim FileName As String = "OperationsReport_TransferCarRental" + DateTime.Now.ToString("yyddmmhhttss") + ".xlsx"
        Dim FilePath As String = Server.MapPath(FolderPath + FileName)
        Dim RandomCls As New Random()
        Dim RandomNo As String = RandomCls.Next(100000, 9999999).ToString

        Dim FileNameNew As String = "OperationsReport_" & Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second & Now.Millisecond & ".xlsx"
        document = New XLWorkbook
        Dim ws As IXLWorksheet = wb.Worksheets.Add("OperationsReport")
        ws.Style.Font.FontName = "Times New Roman"

        Dim LineNo As Integer = 2
        ws = TopHeadings(ws, LineNo)
        ws = FilterTextHeading(ws, LineNo, strclassificationName)
        LineNo += 1
        ws = ExcelCreateTransfer(ws, LineNo, strclassificationName)
        LineNo += 2
        ws = ExcelCreateCarRental(ws, LineNo, strclassificationName)


        ws.Column("A").Width = 25 'Agent
        ws.Column("B").Width = 16 'changed by mohamed on 02/01/2019 '13 'Booking No.
        'ws.Column("C").Width = 11  'Service Date
        ws.Column("D").Width = 5  'changed by mohamed on 02/01/2019 'Commented 'Service
        ws.Column("E").Width = 25 'Guest Name
        ws.Column("F").Width = 4 'changed by mohamed on 02/01/2019 'Commented 'Status
        ws.Column("J").Width = 14 'changed by mohamed on 02/01/2019 'Commented 'Created By


        ws.Column("H").Width = 4 'changed by mohamed on 02/01/2019 'Commented 'Pax

        ws.Column("M").Width = 18 'changed by mohamed on 02/01/2019 'Commented 'Pick up
        ws.Column("N").Width = 18 'changed by mohamed on 02/01/2019 'Commented 'Drop Off
        ws.Column("O").Width = 16 'changed by mohamed on 02/01/2019 'Commented 'Supplier
        ws.Column("P").Width = 13 'changed by mohamed on 02/01/2019 'Commented '8 'Remarks
        ws.Column("Q").Width = 11
        ws.Column("R").Width = 11


        'ws = PageSizeSet(ws, LineNo, "R", intColno, True) '*** Danny 31/01/2019
        ws.Range("D1:D" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("H1:H" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("F1:F" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018
        ws.Range("K1:K" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("L1:L" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 


        ws = PageSizeSet(ws, LineNo, "O", 16, True) '*** Danny 31/01/2019
        ''ws.Range("D1:D" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ''ws.Range("H1:H" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ''ws.Range("F1:F" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018
        ''ws.Range("K1:K" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("N1:N" + LineNo.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        Try
            Using MyMemoryStream As New MemoryStream()
                wb.SaveAs(MyMemoryStream)
                wb.Dispose()
                Response.Clear()
                Response.Buffer = True
                Response.AddHeader("content-disposition", "attachment;filename=" + FileNameNew)
                Response.AddHeader("Content-Length", MyMemoryStream.Length.ToString())
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"

                MyMemoryStream.WriteTo(Response.OutputStream)
                Response.Cookies.Add(New HttpCookie("DownloadedArrivals", "True"))
                Response.Flush()
                HttpContext.Current.ApplicationInstance.CompleteRequest()

            End Using
        Catch ex As Exception

        End Try
    End Sub
    Private Sub ExcelCarRental(ByVal strclassificationName As String)
        If myds.Tables(0).Rows.Count = 0 Then
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('No result found!' );", True)
            Exit Sub
        End If
        Dim trow As Integer = 3
        Dim wb As New XLWorkbook

        Dim FolderPath As String = "..\ExcelTemp\"
        Dim FileName As String = "OperationsReport_CarRental" + DateTime.Now.ToString("yyddmmhhttss") + ".xlsx"
        Dim FilePath As String = Server.MapPath(FolderPath + FileName)
        Dim RandomCls As New Random()
        Dim RandomNo As String = RandomCls.Next(100000, 9999999).ToString

        Dim FileNameNew As String = "OperationsReport_" & Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second & Now.Millisecond & ".xlsx"
        document = New XLWorkbook
        Dim ws As IXLWorksheet = wb.Worksheets.Add("OperationsReport")
        ws.Style.Font.FontName = "Times New Roman"

        Dim header As IXLRange
        header = ws.Range("A2:S2")  '*** Danny 07/12/2018 'V to W changed by mohamed on 13/12/2018
        header.Style.Font.SetBold()
        header.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#e2efda"))
        header.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        header.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        header.Merge()
        header.Style.Font.FontSize = 16
        Dim headertext As Object
        headertext = ws.Ranges("e2:S2") '*** Danny 07/12/2018 
        headertext.Style.Font.SetBold()
        headertext.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        headertext.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        headertext.Style.Font.SetBold()
        headertext.Style.Font.FontSize = 16
        headertext.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        headertext.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        Dim range1 As IXLRange
        range1 = ws.Range("e2:S2") '*** Danny 07/12/2018 
        range1.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range1.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        range1.Merge()
        range1.Value = CType(Session("CompanyName"), String)
        range1.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        range1.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)




        Dim header2 As IXLRange
        header2 = ws.Range("A3:S3")  '*** Danny 07/12/2018 'V to W changed by mohamed on 13/12/2018
        header2.Style.Font.SetBold()
        header2.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#FFE5CC"))
        header2.Merge()
        header2.Style.Font.FontSize = 14
        Dim headertext2 As Object
        headertext2 = ws.Ranges("e3:h3")
        headertext2.Style.Font.SetBold()
        headertext2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        headertext2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        Dim range2 As IXLRange
        range2 = ws.Range("e3:M3") 'changed by mohamed on 09/12/2018 to h to j
        Dim multiline As Object
        multiline = String.Concat("Operations List for Date " & IIf(txtFromDate.Text = txtToDate.Text, "", "range ") & ": " + txtFromDate.Text + IIf(txtFromDate.Text = txtToDate.Text, "", " - " & txtToDate.Text)) 'changed by mohamed on 09/12/2018
        range2.Cell(1, 1).Value = multiline
        range2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        range2.Merge()



        Dim repfilter As New StringBuilder

        ws.Cell(4, 1).Value = repfilter
        If Txt_BookinNo.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append("Booking No: " & Txt_BookinNo.Text & "")
        End If
        If Txt_OldBookinRef.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Old Ref: " & Txt_OldBookinRef.Text & "")
        End If
        If Txt_AgentRef.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Agent Ref: " & Txt_AgentRef.Text & "")
        End If
        If ddlServiceName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Service: " & ddlServiceName.Text & "")
        End If
        If strclassificationName.Trim <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Service Classification : " & strclassificationName.Trim & "")
        End If
        If Txt_LocationName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Location : " & Txt_LocationName.Text & "")
        End If
        If TxtHotelName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Supplier : " & TxtHotelName.Text & "")
        End If
        If TxtAgentName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Agent : " & TxtAgentName.Text & "")
        End If
        If Txt_AirportName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Airports : " & Txt_AirportName.Text & "")
        End If
        If TxtFlightName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Flight :  " & TxtFlightName.Text & "")
        End If
        If ddlBookingStatus.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Service Status :  " & ddlBookingStatus.Text & "")
        End If
        If ddlBookingStatusManual.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Booking Status :  " & ddlBookingStatusManual.Text & "")
        End If

        If chk_SelfDrive.Checked = True Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Self Drive: YES")
        Else
            'ws.Cell(4, 1).Value = repfilter.Append(" , Self Drive: NO")
        End If

        'ws.Range(4, 1, 4, 23).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)

        trow = 5

        ws.Column("A").Width = 16
        ws.Column("B").Width = 16 'changed by mohamed on 02/01/2019 '13
        ws.Column("C").Width = 10
        ws.Column("D").Width = 10
        ws.Column("E").Width = 22
        ws.Column("F").Width = 4 'changed by mohamed on 02/01/2019 '8
        ws.Column("G").Width = 8
        ws.Column("H").Width = 4 'changed by mohamed on 02/01/2019 '10
        ws.Column("I").Width = 14
        ws.Column("J").Width = 11
        ws.Column("K").Width = 8
        ws.Column("L").Width = 16 'changed by mohamed on 02/01/2019 '8
        ws.Column("M").Width = 11
        ws.Column("N").Width = 8
        ws.Column("O").Width = 16 'changed by mohamed on 02/01/2019 '14
        ws.Column("P").Width = 14
        ws.Column("Q").Width = 13 'changed by mohamed on 02/01/2019 '8
        ws.Column("R").Width = 16 '*** Danny 07/12/2018 
        ' ws.Column("Q").Width = 11
        'ws.Column("t").Width = 10
        'ws.Column("U").Width = 11
        'ws.Column("V").Width = 25

        'Dim title = ws.Range(trow, 1, trow, 24)

        'Dim bookingtitle = ws.Range(trow, 1, trow, 24).Style.Font.SetBold()
        'ws.Range(trow, 1, trow, 22).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        'ws.Range(trow, 1, trow, 22).Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        'bookingtitle.Alignment.WrapText = True
        Dim intColno As Integer = 1

        ws.Cell(trow, intColno).Value = "Agent"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Booking No."
        intColno = intColno + 1
        'ws.Cell(trow, intColno).Value = "Old Booking Ref"
        'intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Service Date"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Classification"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Guest Name"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "STS" 'changed by mohamed on 02/01/2019 '"Status"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Created By"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "PAX" 'changed by mohamed on 02/01/2019 '"Adult" + vbCr + "Child" + vbCr + "Total Pax"
        intColno = intColno + 1
        'ws.Cell(trow, intColno).Value =
        'intColno = intColno + 1
        'ws.Cell(trow, intColno).Value =
        'intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Car Details"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Delivery Date"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Delivery Time"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Delivery Hotel"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Drop Off Date"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Drop Off Time"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Drop Off Hotel"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Supplier"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Service Remarks"
        intColno = intColno + 1 '*** Danny 07/12/2018 
        ws.Cell(trow, intColno).Value = "Old Ref"
        intColno = intColno + 1  '*** Danny 11/12/2018 
        ws.Cell(trow, intColno).Value = "ServiceAddModDate"

        'ws.Cell(trow, 4).Value = "CheckOut"
        'ws.Cell(trow, 7).Value = "Service Type"
        'ws.Cell(trow, 10).Value = "Pick Up Time"
        'ws.Cell(trow, 11).Value = "FlightNo"
        'ws.Cell(trow, 12).Value = "Flight Time"
        'ws.Cell(trow, 13).Value = "Pick Up"
        ws.Range(3, 1, 3, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(3, 1, 3, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018

        ws.Range(4, 1, 4, intColno).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)

        Dim title = ws.Range(trow, 1, trow, intColno)

        Dim bookingtitle = ws.Range(trow, 1, trow, intColno).Style.Font.SetBold()
        ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        bookingtitle.Alignment.WrapText = True

        ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)



        trow = trow + 1
        If myds.Tables(0).Rows.Count >= 0 Then
            For Each bookingdetail In myds.Tables(0).Rows

                title = ws.Range(++trow, 1, trow, intColno) '*** Danny 07/12/2018 
                title.Style.Alignment.WrapText = True

                intColno = 1
                ws.Cell(trow, intColno).Value = bookingdetail("agentname")
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = "New: " & bookingdetail("requestid") + vbCr + "Old: " & bookingdetail("columbusref") 'changed by mohamed on 02/01/2019
                ws.Cell(trow, intColno).Value = bookingdetail("requestid") '*** Danny 07/12/2018 
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("columbusref")
                'intColno = intColno + 1
                ws.Cell(trow, intColno).Value = (CType(bookingdetail("servicedate"), Date))
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("classification")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("GuestName")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("bookingStatus")
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("CreatedBy")
                If bookingdetail("CreatedBy").ToString.Contains(" ") Then 'changed by mohamed on 02/01/2019
                    ws.Cell(trow, intColno).Value = Left(bookingdetail("CreatedBy"), InStr(bookingdetail("CreatedBy"), " ") - 1)
                Else
                    ws.Cell(trow, intColno).Value = bookingdetail("CreatedBy")
                End If

                intColno = intColno + 1

                'changed by mohamed on 02/01/2019
                ws.Cell(trow, intColno).Value = bookingdetail("Adult").ToString & IIf(bookingdetail("Child").ToString = "" Or bookingdetail("Child").ToString = "0", "", "+" & bookingdetail("Child").ToString)
                'ws.Cell(trow, intColno).Value = "Adult: " + bookingdetail("Adult").ToString + vbCr + "Child: " + bookingdetail("Child").ToString + vbCr + "Total: " + bookingdetail("TotalPax").ToString

                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("Child")
                'intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("TotalPax")
                'intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("servicename")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("carrentalDeliveryDate")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = "'" + bookingdetail("carrentalDeliveryTime")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("carrentalDeliveryPlace")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("carrentalPickupDate")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = "'" + bookingdetail("carrentalPickupTime")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("carrentalPickupPlace")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("partyname")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = "BD:" & bookingdetail("bookingdate") + vbCr + bookingdetail("ServiceRemark")
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = (CType(bookingdetail("bookingdate"), Date))
                ws.Cell(trow, intColno).Value = bookingdetail("columbusref") '*** Danny 07/12/2018 
                intColno = intColno + 1 '*** Danny 11/12/2018 
                ws.Cell(trow, intColno).Value = bookingdetail("ServiceAddModDate")



                'ws.Cell(trow, intColno).Value = bookingdetail("checkout")
                'intColno = intColno + 1


                'ws.Cell(trow, intColno).Value = bookingdetail("servicetype")
                'intColno = intColno + 1


                'ws.Cell(trow, intColno).Value = bookingdetail("pickuptime")
                'intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("flightno")
                'intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("flighttime")
                'intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("pickup")
                'intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("dropoff")
                'intColno = intColno + 1
                ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
                ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)

                ws.Range(trow, 1, trow, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018

                trow = trow + 1
            Next

        End If
        ws = PageSizeSet(ws, trow, "S", intColno, True) '*** Danny 31/01/2019
        ws.Range("D1:D" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("H1:H" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("F1:F" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018
        ws.Range("K1:K" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("N1:N" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        Try
            Using MyMemoryStream As New MemoryStream()
                wb.SaveAs(MyMemoryStream)
                wb.Dispose()
                Response.Clear()
                Response.Buffer = True
                Response.AddHeader("content-disposition", "attachment;filename=" + FileNameNew)
                Response.AddHeader("Content-Length", MyMemoryStream.Length.ToString())
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"

                MyMemoryStream.WriteTo(Response.OutputStream)
                Response.Cookies.Add(New HttpCookie("DownloadedArrivals", "True"))
                Response.Flush()
                HttpContext.Current.ApplicationInstance.CompleteRequest()

            End Using
        Catch ex As Exception

        End Try
    End Sub
    Private Sub ExcelGuidedTour(ByVal strclassificationName As String)
        If myds.Tables(0).Rows.Count = 0 Then
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('No result found!' );", True)
            Exit Sub
        End If
        Dim trow As Integer = 3
        Dim wb As New XLWorkbook

        Dim FolderPath As String = "..\ExcelTemp\"
        Dim FileName As String = "OperationsReport_Guided" + DateTime.Now.ToString("yyddmmhhttss") + ".xlsx"
        Dim FilePath As String = Server.MapPath(FolderPath + FileName)
        Dim RandomCls As New Random()
        Dim RandomNo As String = RandomCls.Next(100000, 9999999).ToString

        Dim FileNameNew As String = "OperationsReport_" & Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second & Now.Millisecond & ".xlsx"
        document = New XLWorkbook
        Dim ws As IXLWorksheet = wb.Worksheets.Add("OperationsReport")
        ws.Style.Font.FontName = "Times New Roman"

        Dim header As IXLRange
        header = ws.Range("A2:Q2")  '*** Danny 07/12/2018 'V to W changed by mohamed on 13/12/2018
        header.Style.Font.SetBold()
        header.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#e2efda"))
        header.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        header.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        header.Merge()
        header.Style.Font.FontSize = 16
        Dim headertext As Object
        headertext = ws.Ranges("e2:Q2") '*** Danny 07/12/2018 
        headertext.Style.Font.SetBold()
        headertext.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        headertext.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        headertext.Style.Font.SetBold()
        headertext.Style.Font.FontSize = 16
        headertext.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        headertext.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        Dim range1 As IXLRange
        range1 = ws.Range("e2:Q2") '*** Danny 07/12/2018 
        range1.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range1.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        range1.Merge()
        range1.Value = CType(Session("CompanyName"), String)
        range1.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        range1.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)




        Dim header2 As IXLRange
        header2 = ws.Range("A3:Q3")  '*** Danny 07/12/2018 'V to W changed by mohamed on 13/12/2018
        header2.Style.Font.SetBold()
        header2.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#FFE5CC"))
        header2.Merge()
        header2.Style.Font.FontSize = 14
        Dim headertext2 As Object
        headertext2 = ws.Ranges("e3:h3")
        headertext2.Style.Font.SetBold()
        headertext2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        headertext2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        Dim range2 As IXLRange
        range2 = ws.Range("e3:M3") 'changed by mohamed on 09/12/2018 to h to j
        Dim multiline As Object
        multiline = String.Concat("Operations List for Date " & IIf(txtFromDate.Text = txtToDate.Text, "", "range ") & ": " + txtFromDate.Text + IIf(txtFromDate.Text = txtToDate.Text, "", " - " & txtToDate.Text)) 'changed by mohamed on 09/12/2018
        range2.Cell(1, 1).Value = multiline
        range2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        range2.Merge()



        Dim repfilter As New StringBuilder

        ws.Cell(4, 1).Value = repfilter
        If Txt_BookinNo.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append("Booking No: " & Txt_BookinNo.Text & "")
        End If
        If Txt_OldBookinRef.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Old Ref: " & Txt_OldBookinRef.Text & "")
        End If
        If Txt_AgentRef.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Agent Ref: " & Txt_AgentRef.Text & "")
        End If
        If ddlServiceName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Service: " & ddlServiceName.Text & "")
        End If
        If strclassificationName.Trim <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Service Classification : " & strclassificationName.Trim & "")
        End If
        If Txt_LocationName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Location : " & Txt_LocationName.Text & "")
        End If
        If TxtHotelName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Supplier : " & TxtHotelName.Text & "")
        End If
        If TxtAgentName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Agent : " & TxtAgentName.Text & "")
        End If
        If Txt_AirportName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Airports : " & Txt_AirportName.Text & "")
        End If
        If TxtFlightName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Flight :  " & TxtFlightName.Text & "")
        End If
        If ddlBookingStatus.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Service Status :  " & ddlBookingStatus.Text & "")
        End If
        If ddlBookingStatusManual.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Booking Status :  " & ddlBookingStatusManual.Text & "")
        End If

        If chk_SelfDrive.Checked = True Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Self Drive: YES")
        Else
            'ws.Cell(4, 1).Value = repfilter.Append(" , Self Drive: NO")
        End If

        'ws.Range(4, 1, 4, 23).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)

        trow = 5

        ws.Column("A").Width = 16
        ws.Column("B").Width = 16 'changed by mohamed on 02/01/2019 '13
        ws.Column("C").Width = 10
        ws.Column("D").Width = 10
        ws.Column("E").Width = 22
        ws.Column("F").Width = 4 'changed by mohamed on 02/01/2019 '8
        'ws.Column("G").Width = 8
        'ws.Column("G").Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center
        ws.Column("H").Width = 4 'changed by mohamed on 02/01/2019 '10
        ws.Column("I").Width = 14
        ws.Column("J").Width = 8
        ws.Column("K").Width = 8
        ws.Column("L").Width = 18 'changed by mohamed on 02/01/2019 '8
        ws.Column("M").Width = 18 'changed by mohamed on 02/01/2019 '8
        ws.Column("N").Width = 16 'changed by mohamed on 02/01/2019 '8
        ws.Column("O").Width = 14
        ws.Column("P").Width = 14
        ws.Column("Q").Width = 11

        Dim intColno As Integer = 1

        ws.Cell(trow, intColno).Value = "Agent"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Booking No."
        intColno = intColno + 1

        ws.Cell(trow, intColno).Value = "Service Start Date"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Service End Date"
        intColno = intColno + 1

        ws.Cell(trow, intColno).Value = "Guest Name"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "STS"
        intColno = intColno + 1

        ws.Cell(trow, intColno).Value = "Created By"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "PAX" 'changed by mohamed on 02/01/2019 '"Adult" + vbCr + "Child" + vbCr + "Total Pax"
        intColno = intColno + 1

        ws.Cell(trow, intColno).Value = "Services"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Tour Language"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Pick Up Time"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Pick Up"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Drop Off"
        intColno = intColno + 1

        ws.Cell(trow, intColno).Value = "Supplier"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Service Remarks"
        intColno = intColno + 1 '*** Danny 07/12/2018 
        ws.Cell(trow, intColno).Value = "Old Ref"
        intColno = intColno + 1  '*** Danny 11/12/2018 
        ws.Cell(trow, intColno).Value = "ServiceAddModDate"

        ws.Range(3, 1, 3, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(3, 1, 3, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018

        ws.Range(4, 1, 4, intColno).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)

        Dim title = ws.Range(trow, 1, trow, intColno)

        Dim bookingtitle = ws.Range(trow, 1, trow, intColno).Style.Font.SetBold()
        ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        bookingtitle.Alignment.WrapText = True

        ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)



        trow = trow + 1
        If myds.Tables(0).Rows.Count >= 0 Then
            For Each bookingdetail In myds.Tables(0).Rows

                title = ws.Range(++trow, 1, trow, intColno)  '*** Danny 11/12/2018 
                title.Style.Alignment.WrapText = True

                intColno = 1
                ws.Cell(trow, intColno).Value = bookingdetail("agentname")
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = "New: " & bookingdetail("requestid") + vbCr + "Old: " & bookingdetail("columbusref") 'changed by mohamed on 02/01/2019
                ws.Cell(trow, intColno).Value = bookingdetail("requestid")   '*** Danny 07/12/2018 
                intColno = intColno + 1

                ws.Cell(trow, intColno).Value = (CType(bookingdetail("servicedate"), Date))
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("checkout")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("GuestName")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("bookingStatus")
                intColno = intColno + 1

                If bookingdetail("CreatedBy").ToString.Contains(" ") Then 'changed by mohamed on 02/01/2019
                    ws.Cell(trow, intColno).Value = Left(bookingdetail("CreatedBy"), InStr(bookingdetail("CreatedBy"), " ") - 1)
                Else
                    ws.Cell(trow, intColno).Value = bookingdetail("CreatedBy")
                End If
                intColno = intColno + 1


                'changed by mohamed on 02/01/2019
                ws.Cell(trow, intColno).Value = bookingdetail("Adult").ToString & IIf(bookingdetail("Child").ToString = "" Or bookingdetail("Child").ToString = "0", "", "+" & bookingdetail("Child").ToString)
                'ws.Cell(trow, intColno).Value = "Adult: " + bookingdetail("Adult").ToString + vbCr + "Child: " + bookingdetail("Child").ToString + vbCr + "Total: " + bookingdetail("TotalPax").ToString

                intColno = intColno + 1

                ws.Cell(trow, intColno).Value = bookingdetail("servicename")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("TourLanguage")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = "'" & bookingdetail("pickuptime")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("pickup")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("dropoff")
                intColno = intColno + 1

                ws.Cell(trow, intColno).Value = bookingdetail("partyname")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = "BD:" & bookingdetail("bookingdate") + vbCr + bookingdetail("ServiceRemark")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("columbusref")   '*** Danny 07/12/2018 

                intColno = intColno + 1 '*** Danny 11/12/2018 
                ws.Cell(trow, intColno).Value = bookingdetail("ServiceAddModDate")



                ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
                ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)

                ws.Range(trow, 1, trow, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018

                trow = trow + 1
            Next

        End If

        'ws = PageSizeSet(ws, trow, "P", intColno, True) '*** Danny 31/01/2019
        ws = PageSizeSet(ws, trow, "Q", intColno, True) '*** Danny 11/02/2019
        ws.Range("F1:F" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("H1:H" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("K1:K" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018
        'ws.Range("J1:J" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        'ws.Range("U1:U" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        Try
            Using MyMemoryStream As New MemoryStream()
                wb.SaveAs(MyMemoryStream)
                wb.Dispose()
                Response.Clear()
                Response.Buffer = True
                Response.AddHeader("content-disposition", "attachment;filename=" + FileNameNew)
                Response.AddHeader("Content-Length", MyMemoryStream.Length.ToString())
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"

                MyMemoryStream.WriteTo(Response.OutputStream)
                Response.Cookies.Add(New HttpCookie("DownloadedArrivals", "True"))
                Response.Flush()
                HttpContext.Current.ApplicationInstance.CompleteRequest()

            End Using
        Catch ex As Exception

        End Try
    End Sub
    Private Sub ExcelTransfer(ByVal strclassificationName As String)
        If myds.Tables(0).Rows.Count = 0 Then
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('No result found!' );", True)
            Exit Sub
        End If
        Dim trow As Integer = 3
        Dim wb As New XLWorkbook

        Dim FolderPath As String = "..\ExcelTemp\"
        Dim FileName As String = "OperationsReport_Transfer" + DateTime.Now.ToString("yyddmmhhttss") + ".xlsx"
        Dim FilePath As String = Server.MapPath(FolderPath + FileName)
        Dim RandomCls As New Random()
        Dim RandomNo As String = RandomCls.Next(100000, 9999999).ToString

        Dim FileNameNew As String = "OperationsReport_" & Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second & Now.Millisecond & ".xlsx"
        document = New XLWorkbook
        Dim ws As IXLWorksheet = wb.Worksheets.Add("OperationsReport")
        ws.Style.Font.FontName = "Times New Roman"



        Dim header As IXLRange
        header = ws.Range("A2:R2")  '*** Danny 07/12/2018 'V to W changed by mohamed on 13/12/2018
        header.Style.Font.SetBold()
        header.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#e2efda"))
        header.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        header.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        header.Merge()
        header.Style.Font.FontSize = 16
        Dim headertext As Object
        headertext = ws.Ranges("e2:R2") '*** Danny 07/12/2018 
        headertext.Style.Font.SetBold()
        headertext.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        headertext.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        headertext.Style.Font.SetBold()
        headertext.Style.Font.FontSize = 16
        headertext.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        headertext.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        Dim range1 As IXLRange
        range1 = ws.Range("e2:R2") '*** Danny 07/12/2018 
        range1.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range1.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        range1.Merge()
        range1.Value = CType(Session("CompanyName"), String)
        range1.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        range1.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)




        Dim header2 As IXLRange
        header2 = ws.Range("A3:R3")  '*** Danny 07/12/2018 'V to W changed by mohamed on 13/12/2018
        header2.Style.Font.SetBold()
        header2.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#FFE5CC"))
        header2.Merge()
        header2.Style.Font.FontSize = 14
        Dim headertext2 As Object
        headertext2 = ws.Ranges("e3:h3")
        headertext2.Style.Font.SetBold()
        headertext2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        headertext2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        Dim range2 As IXLRange
        range2 = ws.Range("e3:o3") 'changed by mohamed on 09/12/2018 to h to j
        Dim multiline As Object
        multiline = String.Concat("Operations List for Date " & IIf(txtFromDate.Text = txtToDate.Text, "", "range ") & ": " + txtFromDate.Text + IIf(txtFromDate.Text = txtToDate.Text, "", " - " & txtToDate.Text)) 'changed by mohamed on 09/12/2018
        range2.Cell(1, 1).Value = multiline
        range2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        range2.Merge()


        Dim repfilter As New StringBuilder

        ws.Cell(4, 1).Value = repfilter
        If Txt_BookinNo.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append("Booking No: " & Txt_BookinNo.Text & "")
        End If
        If Txt_OldBookinRef.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Old Ref: " & Txt_OldBookinRef.Text & "")
        End If
        If Txt_AgentRef.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Agent Ref: " & Txt_AgentRef.Text & "")
        End If
        If ddlServiceName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Service: " & ddlServiceName.Text & "")
        End If
        If strclassificationName.Trim <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Service Classification : " & strclassificationName.Trim & "")
        End If
        If Txt_LocationName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Location : " & Txt_LocationName.Text & "")
        End If
        If TxtHotelName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Supplier : " & TxtHotelName.Text & "")
        End If
        If TxtAgentName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Agent : " & TxtAgentName.Text & "")
        End If
        If Txt_AirportName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Airports : " & Txt_AirportName.Text & "")
        End If
        If TxtFlightName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Flight :  " & TxtFlightName.Text & "")
        End If
        If ddlBookingStatus.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Service Status :  " & ddlBookingStatus.Text & "")
        End If
        If ddlBookingStatusManual.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Booking Status :  " & ddlBookingStatusManual.Text & "")
        End If

        If chk_SelfDrive.Checked = True Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Self Drive: YES")
        Else
            'ws.Cell(4, 1).Value = repfilter.Append(" , Self Drive: NO")
        End If




        trow = 5

        ws.Column("A").Width = 16 'Agent
        ws.Column("B").Width = 16 'changed by mohamed on 02/01/2019 '13 'Booking No.
        'ws.Column("C").Width = 11  'Service Date
        ws.Column("D").Width = 5  'changed by mohamed on 02/01/2019 'Commented 'Service
        ws.Column("E").Width = 22 'Guest Name
        ws.Column("F").Width = 4 'changed by mohamed on 02/01/2019 'Commented 'Status
        'ws.Column("G").Width = 4 'changed by mohamed on 02/01/2019 'Commented 'Created By


        ws.Column("H").Width = 4 'changed by mohamed on 02/01/2019 'Commented 'Pax

        ws.Column("M").Width = 18 'changed by mohamed on 02/01/2019 'Commented 'Pick up
        ws.Column("N").Width = 18 'changed by mohamed on 02/01/2019 'Commented 'Drop Off
        ws.Column("O").Width = 16 'changed by mohamed on 02/01/2019 'Commented 'Supplier
        ws.Column("P").Width = 13 'changed by mohamed on 02/01/2019 'Commented '8 'Remarks
        ws.Column("Q").Width = 11
        ws.Column("R").Width = 11


        Dim intColno As Integer = 1
        ws.Cell(trow, intColno).Value = "Agent"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Booking No."
        intColno = intColno + 1
        'ws.Cell(trow, 2).Value = "Old Booking Ref"
        ws.Cell(trow, intColno).Value = "Service Date"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "TRF" 'changed by mohamed on 02/01/2019 '"Classification"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Guest Name"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "STS" 'changed by mohamed on 02/01/2019 '"Status"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Created By"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "PAX" 'changed by mohamed on 02/01/2019 '"Adult" + vbCr + "Child" + vbCr + "Total Pax" 
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Car Type"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "FlightNo"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Flight Time"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Pick Up Time"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Pick Up"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Drop Off"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Supplier/Driver"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Service Remarks"
        intColno = intColno + 1
        ws.Cell(trow, intColno).Value = "Old Ref"        '*** Danny 07/12/2018 
        intColno = intColno + 1  '*** Danny 11/12/2018 
        ws.Cell(trow, intColno).Value = "ServiceAddModDate"


        ws.Range(3, 1, 3, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(3, 1, 3, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        'ws.Cell(trow, 23).Value = "Consultant Name" 'changed by mohamed on 13/12/2018
        'ws.Cell(4, 1).Value = repfilter.Append(" , Group By:  " & GroupBy.SelectedItem.Text & "  , Division:  " & ddldivisions.SelectedItem.Text & "")
        ws.Range(4, 1, 4, intColno).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left) '17 to 23 changed by mohamed on 13/12/2018
        Dim bookingtitle = ws.Range(trow, 1, trow, intColno).Style.Font.SetBold()
        ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(trow, 1, trow, intColno).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        bookingtitle.Alignment.WrapText = True

        Dim title = ws.Range(trow, 1, trow, intColno)

        ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        ws.Range(trow, 1, trow, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(trow, 1, trow, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018



        trow = trow + 1
        If myds.Tables(0).Rows.Count >= 0 Then
            For Each bookingdetail In myds.Tables(0).Rows
                title = ws.Range(++trow, 1, trow, intColno)   '*** Danny 11/12/2018 
                title.Style.Alignment.WrapText = True

                intColno = 1
                ws.Cell(trow, intColno).Value = bookingdetail("agentname")
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = "New: " + bookingdetail("requestid") + vbCr + "Old: " + bookingdetail("columbusref") 'changed by mohamed on 02/01/2019
                ws.Cell(trow, intColno).Value = bookingdetail("requestid")   '*** Danny 07/12/2018 
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("columbusref")
                'intColno = intColno + 1
                ws.Cell(trow, intColno).Value = (CType(bookingdetail("servicedate"), Date))
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = Left(bookingdetail("classification"), 3)
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("GuestName")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("bookingStatus")
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = bookingdetail("checkout")
                'intColno = intColno + 1
                If bookingdetail("CreatedBy").ToString.Contains(" ") Then 'changed by mohamed on 02/01/2019
                    ws.Cell(trow, intColno).Value = Left(bookingdetail("CreatedBy"), InStr(bookingdetail("CreatedBy"), " ") - 1)
                Else
                    ws.Cell(trow, intColno).Value = bookingdetail("CreatedBy")
                End If
                intColno = intColno + 1

                'changed by mohamed on 02/01/2019
                ws.Cell(trow, intColno).Value = bookingdetail("Adult").ToString & IIf(bookingdetail("Child").ToString = "" Or bookingdetail("Child").ToString = "0", "", "+" & bookingdetail("Child").ToString)
                'ws.Cell(trow, intColno).Value = "Adult: " + bookingdetail("Adult").ToString + vbCr + "Child: " + bookingdetail("Child").ToString + vbCr + "Total: " + bookingdetail("TotalPax").ToString

                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("transfercartype")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("flightno")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = "'" & bookingdetail("flighttime")
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = "Tour Language"
                'intColno = intColno + 1
                ws.Cell(trow, intColno).Value = "'" & bookingdetail("pickuptime")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("pickup")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("dropoff")
                intColno = intColno + 1
                'ws.Cell(trow, intColno).Value = "Drop Off Hotel"
                'intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("partyname")
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = "BD:" & bookingdetail("bookingdate") & vbCr & bookingdetail("ServiceRemark") 'changed by mohamed on 02/01/2019
                intColno = intColno + 1
                ws.Cell(trow, intColno).Value = bookingdetail("columbusref")   '*** Danny 07/12/2018 
                intColno = intColno + 1 '*** Danny 11/12/2018 
                ws.Cell(trow, intColno).Value = bookingdetail("ServiceAddModDate")



                ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
                ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
                'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, intColno).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, intColno).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, intColno).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018

                trow = trow + 1
            Next

        End If
        'ws = PageSizeSet(ws, trow, "P", intColno, True) '*** Danny 31/01/2019
        ws = PageSizeSet(ws, trow, "R", intColno, True) '*** Danny 31/01/2019
        ws.Range("D1:D" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("H1:H" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("F1:F" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018
        ws.Range("K1:K" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("L1:L" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        Try
            Using MyMemoryStream As New MemoryStream()
                wb.SaveAs(MyMemoryStream)
                wb.Dispose()
                Response.Clear()
                Response.Buffer = True
                Response.AddHeader("content-disposition", "attachment;filename=" + FileNameNew)
                Response.AddHeader("Content-Length", MyMemoryStream.Length.ToString())
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"

                MyMemoryStream.WriteTo(Response.OutputStream)
                Response.Cookies.Add(New HttpCookie("DownloadedArrivals", "True"))
                Response.Flush()
                HttpContext.Current.ApplicationInstance.CompleteRequest()

            End Using
        Catch ex As Exception

        End Try
    End Sub
    Private Sub ExcelCommon(ByVal strclassificationName As String)
        If myds.Tables(0).Rows.Count = 0 Then
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('No result found!' );", True)
            Exit Sub
        End If
        Dim trow As Integer = 3
        Dim wb As New XLWorkbook

        Dim FolderPath As String = "..\ExcelTemp\"
        Dim FileName As String = "OperationsReport" + DateTime.Now.ToString("yyddmmhhttss") + ".xlsx"
        Dim FilePath As String = Server.MapPath(FolderPath + FileName)
        Dim RandomCls As New Random()
        Dim RandomNo As String = RandomCls.Next(100000, 9999999).ToString

        Dim FileNameNew As String = "OperationsReport_" & Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second & Now.Millisecond & ".xlsx"
        document = New XLWorkbook
        Dim ws As IXLWorksheet = wb.Worksheets.Add("OperationsReport")
        ws.Style.Font.FontName = "Times New Roman"



        Dim header As IXLRange
        header = ws.Range("A2:W2") 'V to W changed by mohamed on 13/12/2018
        header.Style.Font.SetBold()
        header.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#e2efda"))
        header.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        header.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        header.Merge()
        header.Style.Font.FontSize = 16
        Dim headertext As Object
        headertext = ws.Ranges("e2:W2")
        headertext.Style.Font.SetBold()
        headertext.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        headertext.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        headertext.Style.Font.SetBold()
        headertext.Style.Font.FontSize = 16
        headertext.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        headertext.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)
        Dim range1 As IXLRange
        range1 = ws.Range("e2:W2")
        range1.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range1.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        range1.Merge()
        range1.Value = CType(Session("CompanyName"), String)
        range1.Style.Border.SetBottomBorder(XLBorderStyleValues.Thin)
        range1.Style.Border.SetTopBorder(XLBorderStyleValues.Thin)




        Dim header2 As IXLRange
        header2 = ws.Range("A3:W3") 'V to W changed by mohamed on 13/12/2018
        header2.Style.Font.SetBold()
        header2.Style.Fill.SetBackgroundColor(XLColor.FromHtml("#FFE5CC"))
        header2.Merge()
        header2.Style.Font.FontSize = 14
        Dim headertext2 As Object
        headertext2 = ws.Ranges("e3:h3")
        headertext2.Style.Font.SetBold()
        headertext2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        headertext2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        Dim range2 As IXLRange
        range2 = ws.Range("e3:j3") 'changed by mohamed on 09/12/2018 to h to j
        Dim multiline As Object
        multiline = String.Concat("Operations List for Date " & IIf(txtFromDate.Text = txtToDate.Text, "", "range ") & ": " + txtFromDate.Text + IIf(txtFromDate.Text = txtToDate.Text, "", " - " & txtToDate.Text)) 'changed by mohamed on 09/12/2018
        range2.Cell(1, 1).Value = multiline
        range2.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        range2.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center)
        range2.Merge()

        ws.Range(3, 1, 3, 23).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(3, 1, 3, 23).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        Dim repfilter As New StringBuilder

        ws.Cell(4, 1).Value = repfilter
        If Txt_BookinNo.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append("Booking No: " & Txt_BookinNo.Text & "")
        End If
        If Txt_OldBookinRef.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Old Ref: " & Txt_OldBookinRef.Text & "")
        End If
        If Txt_AgentRef.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Agent Ref: " & Txt_AgentRef.Text & "")
        End If
        If ddlServiceName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" Service: " & ddlServiceName.Text & "")
        End If
        If strclassificationName.Trim <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Service Classification : " & strclassificationName.Trim & "")
        End If
        If Txt_LocationName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Location : " & Txt_LocationName.Text & "")
        End If
        If TxtHotelName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Supplier : " & TxtHotelName.Text & "")
        End If
        If TxtAgentName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Agent : " & TxtAgentName.Text & "")
        End If
        If Txt_AirportName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Airports : " & Txt_AirportName.Text & "")
        End If
        If TxtFlightName.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Flight :  " & TxtFlightName.Text & "")
        End If
        If ddlBookingStatus.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Service Status :  " & ddlBookingStatus.Text & "")
        End If
        If ddlBookingStatusManual.Text <> "" Then
            ws.Cell(4, 1).Value = repfilter.Append(",  Booking Status :  " & ddlBookingStatusManual.Text & "")
        End If

        If chk_SelfDrive.Checked = True Then
            ws.Cell(4, 1).Value = repfilter.Append(" , Self Drive: YES")
        Else
            'ws.Cell(4, 1).Value = repfilter.Append(" , Self Drive: NO")
        End If


        'ws.Cell(4, 1).Value = repfilter.Append(" , Group By:  " & GroupBy.SelectedItem.Text & "  , Division:  " & ddldivisions.SelectedItem.Text & "")
        ws.Range(4, 1, 4, 23).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left) '17 to 23 changed by mohamed on 13/12/2018

        trow = 5

        ws.Column("A").Width = 10
        ws.Column("B").Width = 15
        ws.Column("C").Width = 11
        ws.Column("D").Width = 11
        ws.Column("E").Width = 20
        ws.Column("F").Width = 25
        ws.Column("G").Width = 15
        ws.Column("H").Width = 20
        ws.Column("I").Width = 35
        ws.Column("J").Width = 14
        ws.Column("K").Width = 14
        ws.Column("L").Width = 14
        ws.Column("M").Width = 14
        ws.Column("N").Width = 14
        ws.Column("O").Width = 8
        ws.Column("P").Width = 8
        ws.Column("Q").Width = 8
        ws.Column("R").Width = 25
        ws.Column("S").Width = 25
        ws.Column("t").Width = 10
        ws.Column("U").Width = 11
        ws.Column("V").Width = 25
        ws.Column("W").Width = 11
        Dim title = ws.Range(trow, 1, trow, 23)

        Dim bookingtitle = ws.Range(trow, 1, trow, 23).Style.Font.SetBold()
        ws.Range(trow, 1, trow, 23).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(trow, 1, trow, 23).Style.Border.SetTopBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        bookingtitle.Alignment.WrapText = True
        ws.Cell(trow, 1).Value = "Booking No."
        ws.Cell(trow, 2).Value = "Old Booking Ref"
        ws.Cell(trow, 3).Value = "Service Date"
        ws.Cell(trow, 4).Value = "CheckOut"
        ws.Cell(trow, 5).Value = "Agent"
        ws.Cell(trow, 6).Value = "Supplier"
        ws.Cell(trow, 7).Value = "Service Type"
        ws.Cell(trow, 8).Value = "Classification"
        ws.Cell(trow, 9).Value = "Services"
        ws.Cell(trow, 10).Value = "Pick Up Time"
        ws.Cell(trow, 11).Value = "FlightNo"
        ws.Cell(trow, 12).Value = "Flight Time"
        ws.Cell(trow, 13).Value = "Pick Up"
        ws.Cell(trow, 14).Value = "Drop Off"
        ws.Cell(trow, 15).Value = "Adult"
        ws.Cell(trow, 16).Value = "Child"
        ws.Cell(trow, 17).Value = "Total Pax"
        ws.Cell(trow, 18).Value = "Guest Name"
        ws.Cell(trow, 19).Value = "Service Remarks"
        ws.Cell(trow, 20).Value = "Booking Date"
        ws.Cell(trow, 21).Value = "Status"
        ws.Cell(trow, 22).Value = "Created By"
        ws.Cell(trow, 23).Value = "ServiceAddModDate"  '*** Danny 11/12/2018 
        'ws.Cell(trow, 23).Value = "Consultant Name" 'changed by mohamed on 13/12/2018
        ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
        ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
        ws.Range(trow, 1, trow, 23).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(trow, 1, trow, 23).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018
        ws.Range(trow, 1, trow, 23).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'V to W changed by mohamed on 13/12/2018



        trow = trow + 1
        If myds.Tables(0).Rows.Count >= 0 Then
            For Each bookingdetail In myds.Tables(0).Rows
                title = ws.Range(++trow, 1, trow, 23)
                title.Style.Alignment.WrapText = True
                ws.Cell(trow, 1).Value = bookingdetail("requestid")
                ws.Cell(trow, 2).Value = bookingdetail("columbusref")
                ws.Cell(trow, 3).Value = (CType(bookingdetail("servicedate"), Date))
                ws.Cell(trow, 4).Value = bookingdetail("checkout")
                ws.Cell(trow, 5).Value = bookingdetail("agentname")
                ws.Cell(trow, 6).Value = bookingdetail("partyname")
                ws.Cell(trow, 7).Value = bookingdetail("servicetype")
                ws.Cell(trow, 8).Value = bookingdetail("classification")
                ws.Cell(trow, 9).Value = bookingdetail("servicename")
                ws.Cell(trow, 10).Value = "'" & bookingdetail("pickuptime")
                ws.Cell(trow, 11).Value = bookingdetail("flightno")
                ws.Cell(trow, 12).Value = "'" & bookingdetail("flighttime")
                ws.Cell(trow, 13).Value = bookingdetail("pickup")
                ws.Cell(trow, 14).Value = bookingdetail("dropoff")
                ws.Cell(trow, 15).Value = bookingdetail("Adult")
                ws.Cell(trow, 16).Value = bookingdetail("Child")
                ws.Cell(trow, 17).Value = bookingdetail("TotalPax")
                ws.Cell(trow, 18).Value = bookingdetail("GuestName")
                ws.Cell(trow, 19).Value = bookingdetail("ServiceRemark")
                ws.Cell(trow, 20).Value = (CType(bookingdetail("bookingdate"), Date))

                ws.Cell(trow, 21).Value = bookingdetail("bookingStatus")
                ws.Cell(trow, 22).Value = bookingdetail("CreatedBy")
                ws.Cell(trow, 23).Value = bookingdetail("ServiceAddModDate") '*** Danny 11/12/2018 

                ws.Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Left)
                ws.Style.Alignment.SetVertical(XLAlignmentVerticalValues.Center)
                'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, 23).Style.Border.SetLeftBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, 23).Style.Border.SetRightBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018
                ws.Range(trow, 1, trow, 23).Style.Border.SetBottomBorder(XLBorderStyleValues.Thin) 'changed by mohamed on 13/12/2018

                trow = trow + 1
            Next

        End If
        ws = PageSizeSet(ws, trow, "W", 23, False) '*** Danny 31/01/2019
        ws.Range("G1:G" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("Q1:Q" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("L1:L" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018
        ws.Range("J1:J" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        ws.Range("U1:U" + trow.ToString).Style.Alignment.SetHorizontal(XLAlignmentHorizontalValues.Center) '*** Danny 07/12/2018 
        Try
            Using MyMemoryStream As New MemoryStream()
                wb.SaveAs(MyMemoryStream)
                wb.Dispose()
                Response.Clear()
                Response.Buffer = True
                Response.AddHeader("content-disposition", "attachment;filename=" + FileNameNew)
                Response.AddHeader("Content-Length", MyMemoryStream.Length.ToString())
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"

                MyMemoryStream.WriteTo(Response.OutputStream)
                Response.Cookies.Add(New HttpCookie("DownloadedArrivals", "True"))
                Response.Flush()
                HttpContext.Current.ApplicationInstance.CompleteRequest()

            End Using
        Catch ex As Exception

        End Try
    End Sub
    Private Function PageSizeSet(ByVal ws As IXLWorksheet, ByVal trow As Integer, ByVal strendcol As String, ByVal intendcol As Integer, ByVal abFitColumnsToPage As Boolean) As IXLWorksheet '*** Danny 31/01/2019
        ws.PageSetup.PageOrientation = XLPageOrientation.Landscape
        ws.PageSetup.PrintAreas.Add("A1:" + strendcol + trow.ToString)
        ws.PageSetup.PaperSize = XLPaperSize.A4Paper

        'ws.PageSetup.AddHorizontalPageBreak(22)
        ws.PageSetup.AddVerticalPageBreak(intendcol)


        ws.PageSetup.Margins.Top = 0.75
        ws.PageSetup.Margins.Bottom = 0.75
        ws.PageSetup.Margins.Left = 0.5
        ws.PageSetup.Margins.Right = 0.5
        ws.PageSetup.Margins.Footer = 0.15
        ws.PageSetup.Margins.Header = 0.3

        ws.PageSetup.CenterHorizontally = True
        'ws.PageSetup.CenterVertically = True

        If abFitColumnsToPage = True Then
            ws.PageSetup.PagesWide = 1
        End If
        Return ws
    End Function
#Region "Protected Sub btnLoadReport_Click(sender As Object, e As System.EventArgs) Handles btnLoadReport.Click"
    Protected Sub btnLoadReport_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnLoadReport.Click


        Try
            If ddlBookingDate.SelectedValue = "Specific date" Then
                If Not IsDate(txtBookingFromDate.Text.Trim) Then
                    ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Check booking from date');", True)

                    Exit Sub
                End If

                If Not IsDate(txtBookingToDate.Text.Trim) Then
                    ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Check booking to date');", True)

                    Exit Sub
                End If
            End If

            If ddl_ServiceModifyDate.SelectedValue = "Specific date" Then
                If Not IsDate(txtServiceModifyFromDate.Text.Trim) Then
                    ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Check Service Modify from date');", True)

                    Exit Sub
                End If

                If Not IsDate(txtServiceModifyToDate.Text.Trim) Then
                    ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Check Service Modify to date');", True)

                    Exit Sub
                End If
            End If
            mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))           'connection open
            mySqlCmd = New SqlCommand("sp_rep_operation_summary", mySqlConn)
            mySqlCmd.CommandType = CommandType.StoredProcedure

            mySqlCmd.Parameters.Add(New SqlParameter("@fromdate", SqlDbType.VarChar, 20)).Value = Convert.ToDateTime(txtFromDate.Text).ToString("yyyy/MM/dd")
            mySqlCmd.Parameters.Add(New SqlParameter("@todate", SqlDbType.VarChar, 20)).Value = Convert.ToDateTime(txtToDate.Text).ToString("yyyy/MM/dd")
            mySqlCmd.Parameters.Add(New SqlParameter("@requestid", SqlDbType.VarChar, 20)).Value = CType(IIf(Txt_BookinNo.Text.Trim = "", "", Txt_BookinNo.Text.Trim), String)
            mySqlCmd.Parameters.Add(New SqlParameter("@columbusref", SqlDbType.VarChar, 20)).Value = CType(IIf(Txt_OldBookinRef.Text.Trim = "", "", Txt_OldBookinRef.Text.Trim), String)
            mySqlCmd.Parameters.Add(New SqlParameter("@agentcode", SqlDbType.VarChar, 100)).Value = CType(IIf(TxtAgentCode.Text.Trim <> "", TxtAgentCode.Text.Trim, ""), String)
            mySqlCmd.Parameters.Add(New SqlParameter("@partycode", SqlDbType.VarChar, 100)).Value = CType(IIf(TxtHotelCode.Text.Trim <> "", TxtHotelCode.Text.Trim, ""), String)
            mySqlCmd.Parameters.Add(New SqlParameter("@servicetype", SqlDbType.VarChar, 100)).Value = CType(IIf(ddlServiceName.Text.Trim <> "" And ddlServiceName.Text.ToUpper <> "ALL", ddlServiceName.Text.Trim, ""), String)

            Dim strclassificationCode As String = ""
            Dim strclassificationName As String = ""
            Dim chk As New CheckBox
            Dim lbls As New Label
            Dim lblsN As New Label
            Dim boolCarRental As Boolean = False
            Dim boolGuidedTour As Boolean = False
            Dim strservice As String = ddlServiceName.Text.Trim.ToUpper
            If ddlServiceName.Text.ToUpper = "ALL" Then
                strclassificationCode = ""
                strclassificationName = ""
            Else

                strclassificationName = strservice + ":"
                For Each row In gv_ServiceClassifications.Rows
                    chk = row.FindControl("clschkwkdays")
                    lbls = row.FindControl("ServiceCode")
                    lblsN = row.FindControl("ServiceName")
                    If chk.Checked = True Then
                        If lblsN.Text.Trim.ToUpper = "Car Rental".ToUpper Then '*** Danny Multiselect 26/12/2018
                            boolCarRental = True
                        End If
                        If lblsN.Text.Trim.ToUpper = "Guided Tours".ToUpper Then
                            boolGuidedTour = True
                        End If
                        If strclassificationCode.Trim.Length > 0 Then
                            strclassificationCode = strclassificationCode + ","
                            strclassificationName = strclassificationName + ","
                        End If
                        strclassificationCode = strclassificationCode + strservice + ":" + lbls.Text.Trim.ToUpper
                        strclassificationName = strclassificationName + lblsN.Text.Trim.ToUpper
                    End If
                Next
                If strclassificationCode.Trim.Length = 0 Then
                    strclassificationCode = ""
                End If
            End If

            Dim showgroup As String = objUtils.ExecuteQueryReturnStringValuenew(Session("dbconnectionName"), "select classificationcode ServiceCode from excclassification_header(nolock) where classificationname='Car Rental'")
            If strservice = "TRANSFER,TOURS" Then
                strclassificationCode = "TRANSFER:ARRIVAL,TRANSFER:DEPARTURE,TRANSFER:INTERHOTEL,TOURS:" + showgroup
            End If

            ''changed by mohamed on 29/12/2018
            'If strservice = "TRANSFER" Then
            '    chk_CarDelivery.Checked = False
            '    chk_CarPickup.Checked = False
            'ElseIf boolCarRental = True And boolGuidedTour = False Then
            'ElseIf boolCarRental = False And boolGuidedTour = True Then
            '    chk_CarDelivery.Checked = False
            '    chk_CarPickup.Checked = False
            'Else
            '    chk_CarDelivery.Checked = False
            '    chk_CarPickup.Checked = False
            'End If

            mySqlCmd.Parameters.Add(New SqlParameter("@serviceclassification", SqlDbType.VarChar, 8000)).Value = CType(IIf(strclassificationCode.Trim <> "", strclassificationCode.Trim, ""), String)
            mySqlCmd.Parameters.Add(New SqlParameter("@bookingstatus", SqlDbType.VarChar, 100)).Value = CType(IIf(ddlBookingStatus.SelectedIndex < 0, "All Active Bookings", ddlBookingStatus.SelectedValue), String)
            mySqlCmd.Parameters.Add(New SqlParameter("@flightno", SqlDbType.VarChar, 20)).Value = CType(IIf(TxtFlightName.Text.Trim <> "", TxtFlightName.Text.Trim, ""), String)
            '*** Danny Multiselect 21/12/2018
            Dim strSelLocat As String = ""
            Dim chked As New CheckBox
            Dim LocationCode As New Label
            For Each rows In gv_Location.Rows
                chked = rows.FindControl("chkwkdays")
                LocationCode = rows.FindControl("ServiceCode")
                If chked.Checked = True Then
                    If strSelLocat.Length > 0 Then
                        strSelLocat = strSelLocat + ","
                    End If
                    strSelLocat = strSelLocat + LocationCode.Text
                End If


            Next
            'mySqlCmd.Parameters.Add(New SqlParameter("@sectorgroup", SqlDbType.VarChar, 20)).Value = CType(IIf(Txt_LocationCode.Text.Trim <> "", Txt_LocationCode.Text.Trim, ""), String)
            mySqlCmd.Parameters.Add(New SqlParameter("@sectorgroup", SqlDbType.VarChar, 8000)).Value = CType(IIf(strSelLocat.Trim <> "", strSelLocat.Trim, ""), String)

            mySqlCmd.Parameters.Add(New SqlParameter("@divcode", SqlDbType.VarChar, 100)).Value = CType("", String)
            mySqlCmd.Parameters.Add(New SqlParameter("@agentref", SqlDbType.VarChar, 20)).Value = CType(IIf(Txt_AgentRef.Text.Trim <> "", Txt_AgentRef.Text.Trim, ""), String)
            If strservice.Trim.ToUpper = "TRANSFER,TOURS" Then
                mySqlCmd.Parameters.Add(New SqlParameter("@selfdrive", SqlDbType.VarChar, 20)).Value = "0" '1
            Else
                mySqlCmd.Parameters.Add(New SqlParameter("@selfdrive", SqlDbType.VarChar, 20)).Value = IIf((chk_SelfDrive.Checked), "1", "0")
            End If
            mySqlCmd.Parameters.Add(New SqlParameter("@airportbordercode", SqlDbType.VarChar, 20)).Value = CType(IIf(Txt_AirportCode.Text.Trim <> "", Txt_AirportCode.Text.Trim, ""), String)

            If (strservice.Trim.ToUpper <> "TOURS" And ddlServiceName.Text.ToUpper <> "ALL" And ddlServiceName.Text.ToUpper <> "") Or chk_SelfDrive.Checked = True Then  'changed by mohamed on 01/01/2019
                mySqlCmd.Parameters.Add(New SqlParameter("@cardeliveryserviceonly", SqlDbType.VarChar, 20)).Value = "0"
                mySqlCmd.Parameters.Add(New SqlParameter("@carpickupserviceonly", SqlDbType.VarChar, 20)).Value = "0"
            Else
                mySqlCmd.Parameters.Add(New SqlParameter("@cardeliveryserviceonly", SqlDbType.VarChar, 20)).Value = CType(IIf(chk_CarDelivery.Checked = True, "1", "0"), String)
                mySqlCmd.Parameters.Add(New SqlParameter("@carpickupserviceonly", SqlDbType.VarChar, 20)).Value = CType(IIf(chk_CarPickup.Checked = True, "1", "0"), String)
            End If

            'mySqlCmd.Parameters.Add(New SqlParameter("@countrygroup", SqlDbType.VarChar, 20)).Value = CType(IIf(TxtSectorCode.Text.Trim <> "", TxtSectorCode.Text.Trim, ""), String)
            'mySqlCmd.Parameters.Add(New SqlParameter("@country", SqlDbType.VarChar, 100)).Value = CType(IIf(TxtCtryCode.Text.Trim <> "", TxtCtryCode.Text.Trim, ""), String)
            'mySqlCmd.Parameters.Add(New SqlParameter("@city", SqlDbType.VarChar, 20)).Value = CType(IIf(TxtCityCode.Text.Trim <> "", TxtCityCode.Text.Trim, ""), String)


            'mySqlCmd.Parameters.Add(New SqlParameter("@groupby", SqlDbType.VarChar, 100)).Value = CType(GroupBy.SelectedValue, Integer)
            'mySqlCmd.Parameters.Add(New SqlParameter("@flightonly", SqlDbType.VarChar, 20)).Value = IIf((chkflightonly.Checked), "1", "0")
            'mySqlCmd.Parameters.Add(New SqlParameter("@shiftonly", SqlDbType.VarChar, 100)).Value = IIf((chkshiftingonly.Checked), "1", "0")
            'mySqlCmd.Parameters.Add(New SqlParameter("@divcode", SqlDbType.VarChar, 20)).Value = CType(IIf(ddldivisions.SelectedValue = -1, "", ddldivisions.SelectedValue), String)

            mySqlCmd.Parameters.Add(New SqlParameter("@ServiceName", SqlDbType.VarChar, 1000)).Value = Txt_ServiceName.Text.Trim
            mySqlCmd.Parameters.Add(New SqlParameter("@bookingdatetype", SqlDbType.VarChar, 50)).Value = ddlBookingDate.SelectedValue
            If ddlBookingDate.SelectedValue = "Specific date" Then
                mySqlCmd.Parameters.Add(New SqlParameter("@bookingdatefrom", SqlDbType.VarChar, 20)).Value = Convert.ToDateTime(txtBookingFromDate.Text.Trim).ToString("yyyy/MM/dd")
                mySqlCmd.Parameters.Add(New SqlParameter("@bookingdateto", SqlDbType.VarChar, 20)).Value = Convert.ToDateTime(txtBookingToDate.Text.Trim).ToString("yyyy/MM/dd")
            Else
                mySqlCmd.Parameters.Add(New SqlParameter("@bookingdatefrom", SqlDbType.VarChar, 20)).Value = txtBookingFromDate.Text.Trim
                mySqlCmd.Parameters.Add(New SqlParameter("@bookingdateto", SqlDbType.VarChar, 20)).Value = txtBookingToDate.Text.Trim
            End If
            mySqlCmd.Parameters.Add(New SqlParameter("@CustomerGroupCode", SqlDbType.VarChar, 20)).Value = Txt_CustomerGroupCode.Text.Trim '*** Danny 08/12/2018
            mySqlCmd.Parameters.Add(New SqlParameter("@HotelChainCode", SqlDbType.VarChar, 20)).Value = Txt_HotelChainCode.Text.Trim '*** Danny 08/12/2018

            If ddl_ServiceModifyDate.SelectedValue = "Specific date" Then
                mySqlCmd.Parameters.Add(New SqlParameter("@ServiceAddModFromDate", SqlDbType.VarChar, 20)).Value = Convert.ToDateTime(txtServiceModifyFromDate.Text.Trim).ToString("yyyy/MM/dd")
                mySqlCmd.Parameters.Add(New SqlParameter("@ServiceAddModToDate", SqlDbType.VarChar, 20)).Value = Convert.ToDateTime(txtServiceModifyToDate.Text.Trim).ToString("yyyy/MM/dd")
            Else
                mySqlCmd.Parameters.Add(New SqlParameter("@ServiceAddModFromDate", SqlDbType.VarChar, 20)).Value = ""
                mySqlCmd.Parameters.Add(New SqlParameter("@ServiceAddModToDate", SqlDbType.VarChar, 20)).Value = ""
            End If
            mySqlCmd.Parameters.Add(New SqlParameter("@bookingstatusmanual", SqlDbType.VarChar, 100)).Value = ddlBookingStatusManual.SelectedValue.Trim.Replace("[Select]", "")  '*** Danny 25/02/2019
            myDataAdapter = New SqlDataAdapter(mySqlCmd)
            myDataAdapter.Fill(myds)
            If strservice.Trim.ToUpper = "TRANSFER,TOURS" Then '*** Danny 22/02/2019
                TransferAndCarRental(strclassificationName)
            Else
                If chk_SelfDrive.Checked = True Then
                    ExcelCarRental(strclassificationName)
                ElseIf strservice.Contains("TRANSFER") Then
                    ExcelTransfer(strclassificationName)
                ElseIf (boolCarRental = True And boolGuidedTour = False) Or chk_SelfDrive.Checked = True Then
                    ExcelCarRental(strclassificationName)
                ElseIf boolCarRental = False And boolGuidedTour = True Then
                    ExcelGuidedTour(strclassificationName)
                Else
                    ExcelCommon(strclassificationName)
                End If
            End If


        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("rptOperationReport.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try









    End Sub
#End Region
    '*** Danny 31/01/2019
#Region "Protected Sub ddlBookingDate_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ddlBookingDate.SelectedIndexChanged"
    Protected Sub ddlBookingDate_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ddlBookingDate.SelectedIndexChanged
        If ddlBookingDate.SelectedItem.Text.ToUpper = "Specific date".ToUpper() Then
            lblBookingFromDate.Visible = True
            dvBookingFromDate.Visible = True

            lblBookingToDate.Visible = True
            dvBookingToDate.Visible = True
        Else
            lblBookingFromDate.Visible = False
            lblBookingToDate.Visible = False
            txtBookingFromDate.Text = ""
            dvBookingFromDate.Visible = False
            txtBookingToDate.Text = ""
            dvBookingToDate.Visible = False
        End If
    End Sub
#End Region

    '*** Danny 11/02/2019
#Region "Protected Sub ddl_ServiceModifyDate_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ddl_ServiceModifyDate.SelectedIndexChanged"
    Protected Sub ddl_ServiceModifyDate_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ddl_ServiceModifyDate.SelectedIndexChanged
        If ddl_ServiceModifyDate.SelectedItem.Text.ToUpper = "Specific date".ToUpper() Then
            lbl_ServiceModifyFromDate.Visible = True
            dvServiceModifyFromDate.Visible = True

            lblServiceModifyToDate.Visible = True
            dvServiceModifyToDate.Visible = True
        Else
            lbl_ServiceModifyFromDate.Visible = False
            lblServiceModifyToDate.Visible = False
            txtServiceModifyFromDate.Text = ""
            dvServiceModifyFromDate.Visible = False
            txtServiceModifyToDate.Text = ""
            dvServiceModifyToDate.Visible = False
        End If
    End Sub
#End Region

    '    <System.Web.Script.Services.ScriptMethod()> _
    '<System.Web.Services.WebMethod()> _
    '    Public Shared Function GetCountrys(ByVal prefixText As String) As List(Of String)
    '        Dim strSqlQry As String = ""

    '        Dim myDS As New DataSet
    '        Dim countrynames As New List(Of String)
    '        Try


    '            strSqlQry = "select ctryname,ctrycode from ctrymast  where  active=1 and  ctryname like  '" & Trim(prefixText) & "%'"

    '            Dim SqlConn As New SqlConnection
    '            Dim myDataAdapter As New SqlDataAdapter
    '            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
    '            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
    '            'Open connection
    '            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
    '            myDataAdapter.Fill(myDS)
    '            If myDS.Tables(0).Rows.Count > 0 Then
    '                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
    '                    countrynames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("ctryname").ToString(), myDS.Tables(0).Rows(i)("ctrycode").ToString()))

    '                Next
    '            End If
    '            Return countrynames
    '        Catch ex As Exception
    '            Return countrynames
    '        End Try
    '    End Function
    '    <System.Web.Script.Services.ScriptMethod()> _
    '<System.Web.Services.WebMethod()> _
    '    Public Shared Function GetHotelcitys(ByVal prefixText As String) As List(Of String)
    '        Dim strSqlQry As String = ""

    '        Dim myDS As New DataSet
    '        Dim citynames As New List(Of String)
    '        Try
    '            strSqlQry = "select cityname,citycode from citymast  where  active=1 and  cityname like  '" & Trim(prefixText) & "%'"
    '            Dim SqlConn As New SqlConnection
    '            Dim myDataAdapter As New SqlDataAdapter
    '            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
    '            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
    '            'Open connection
    '            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
    '            myDataAdapter.Fill(myDS)
    '            If myDS.Tables(0).Rows.Count > 0 Then
    '                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
    '                    citynames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("cityname").ToString(), myDS.Tables(0).Rows(i)("citycode").ToString()))
    '                Next
    '            End If
    '            Return citynames
    '        Catch ex As Exception
    '            Return citynames
    '        End Try
    '    End Function
    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetFlightDetails(ByVal prefixText As String) As List(Of String)
        Dim strSqlQry As String = ""

        Dim myDS As New DataSet
        Dim flightnames As New List(Of String)
        Try
            strSqlQry = "select flightcode,flightcode from flightmast  where  active=1 and  flightcode like  '" & Trim(prefixText) & "%'"
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)
            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    flightnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("flightcode").ToString(), myDS.Tables(0).Rows(i)("flightcode").ToString()))
                Next
            End If
            Return flightnames
        Catch ex As Exception
            Return flightnames
        End Try
    End Function

    <System.Web.Script.Services.ScriptMethod()> _
<System.Web.Services.WebMethod()> _
    Public Shared Function GetAirports(ByVal prefixText As String) As List(Of String)
        Dim strSqlQry As String = ""

        Dim myDS As New DataSet
        Dim flightnames As New List(Of String)
        Try
            strSqlQry = " select  distinct f.airportbordercode,a.airportbordername from flightmast(nolock) f,airportbordersmaster(nolock) a  where f.airportbordercode=a.airportbordercode and a.active=1 and a.airportbordername like  '" & Trim(prefixText) & "%'"
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)
            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    flightnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("airportbordername").ToString(), myDS.Tables(0).Rows(i)("airportbordercode").ToString()))
                Next
            End If
            Return flightnames
        Catch ex As Exception
            Return flightnames
        End Try
    End Function



    '    <System.Web.Script.Services.ScriptMethod()> _
    '<System.Web.Services.WebMethod()> _
    'Public Shared Function GetCountryGroups(ByVal prefixText As String) As List(Of String)
    '    Dim strSqlQry As String = ""

    '    Dim myDS As New DataSet
    '    Dim countrygroupnames As New List(Of String)
    '    Try


    '        strSqlQry = "select countrygroupname,countrygroupcode from countrygroup  where  active=1 and  countrygroupname like  '" & Trim(prefixText) & "%'"

    '        Dim SqlConn As New SqlConnection
    '        Dim myDataAdapter As New SqlDataAdapter
    '        ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
    '        SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
    '        'Open connection
    '        myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
    '        myDataAdapter.Fill(myDS)
    '        If myDS.Tables(0).Rows.Count > 0 Then
    '            For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
    '                countrygroupnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("countrygroupname").ToString(), myDS.Tables(0).Rows(i)("countrygroupcode").ToString()))

    '            Next




    '        End If
    '        Return countrygroupnames
    '    Catch ex As Exception
    '        Return countrygroupnames
    '    End Try
    'End Function

    Protected Sub ddlServiceName_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles ddlServiceName.SelectedIndexChanged
        Txt_ServiceCode.Text = ddlServiceName.SelectedValue
        Call btn_ServiceName_Click(Nothing, Nothing)
    End Sub

    '*** Danny Multiselect 24/12/2018
    <System.Web.Script.Services.ScriptMethod()> _
   <System.Web.Services.WebMethod()> _
    Public Shared Function GetServiceName(ByVal prefixText As String, ByVal count As Integer, ByVal contextKey As String) As List(Of String)

        Dim strSqlQry As String = ""
        Dim myDS As New DataSet
        Dim Hotelnames As New List(Of String)
        Try

            Dim strDest As String = ""
            Dim strStar As String = ""
            Dim strPropType As String = ""
            Dim str As String
            If prefixText = " " Then
                prefixText = ""
            End If
            If contextKey Is Nothing Then
                contextKey = "All"
            End If
            'If contextKey = "" Or contextKey = "All" Then
            '    Dim strContext As String()
            '    strContext = contextKey.Trim.Split("||")
            '    For i As Integer = 0 To strContext.Length - 1
            '        If strContext(i).Contains("DC:") Then
            '            strDest = strContext(i).Replace("DC:", "")
            '        End If

            '    Next

            If contextKey.ToUpper = "Hotel".ToUpper Then
                strSqlQry = "select top 0 partycode ServiceCode,partyname ServiceName from partymast t"
            ElseIf contextKey.ToUpper = "Transfer".ToUpper Then
                strSqlQry = "select  othcatcode ServiceCode,othcatname ServiceName from othcatmast t (nolock) where t.othgrpcode = (select top 1 option_selected from reservation_parameters (nolock) where param_id=1001) AND othcatname Like '%" & prefixText & "%' "

            ElseIf contextKey.ToUpper = "Airportma".ToUpper Then
                strSqlQry = "select othtypcode ServiceCode,othtypname  ServiceName from othtypmast t (nolock) where t.othgrpcode = (select top 1 option_selected from reservation_parameters (nolock) where param_id=1028) AND othtypname LIKE '%" & prefixText & "%' "

            ElseIf contextKey.ToUpper = "Visa".ToUpper Then
                strSqlQry = "select othtypcode  ServiceCode,othtypname  ServiceName from othtypmast t (nolock) where t.othgrpcode = (select top 1 option_selected from reservation_parameters (nolock) where param_id=1002) AND othtypname LIKE '%" & prefixText & "%' "
            ElseIf contextKey.ToUpper = "Tours".ToUpper Then
                strSqlQry = "select exctypcode ServiceCode,exctypname ServiceName from excursiontypes WHERE exctypname LIKE '%" & prefixText & "%' "
            ElseIf contextKey.ToUpper = "Others".ToUpper Then
                strSqlQry = "select t.othtypcode ServiceCode,othtypname  ServiceName  from othtypmast t (nolock), othgrpmast g (nolock) where t.othgrpcode=g.othgrpcode and g.othgrpcode not in ( select * from view_system_othgrp) AND othtypname LIKE '%" & prefixText & "%' "
            Else '*** Danny Multiselect 24/12/2018
                strSqlQry = "select  othcatcode ServiceCode,othcatname ServiceName from othcatmast t (nolock) where t.othgrpcode = (select top 1 option_selected from reservation_parameters (nolock) where param_id=1001) AND othcatname Like '%" & prefixText & "%' " +
                            "UNION ALL select othtypcode ServiceCode,othtypname  ServiceName from othtypmast t (nolock) where t.othgrpcode = (select top 1 option_selected from reservation_parameters (nolock) where param_id=1028) AND othtypname Like '%" & prefixText & "%' " +
                            "UNION ALL select othtypcode  ServiceCode,othtypname  ServiceName from othtypmast t (nolock) where t.othgrpcode = (select top 1 option_selected from reservation_parameters (nolock) where param_id=1002)AND othtypname LIKE '%" & prefixText & "%' " +
                            "UNION ALL select exctypcode ServiceCode,exctypname ServiceName from excursiontypes WHERE exctypname LIKE '%" & prefixText & "%' " +
                            "UNION ALL select t.othtypcode ServiceCode,othtypname  ServiceName  from othtypmast t (nolock), othgrpmast g (nolock) where t.othgrpcode=g.othgrpcode and g.othgrpcode not in ( select * from view_system_othgrp)AND othtypname LIKE '%" & prefixText & "%' "

            End If

            'Dim str As String = contextKey
            'strSqlQry = "select v.partycode,v.partyname from sectormaster(nolock) s,catmast(nolock) c,view_approved_hotels_new v where v.sectorcode=s.sectorcode  and v.catcode=c.catcode   and v.partyname like  '%" & prefixText & "%' "
            'If strDest.Trim <> "" Then
            '    strSqlQry = strSqlQry & " and (v.citycode = '" & strDest.Trim & "' or s.sectorcode = '" & strDest.Trim & "')  "
            'End If
            'strSqlQry = strSqlQry & " order by v.partyname  "
            If strSqlQry.Trim.Length > 0 Then
                Dim SqlConn As New SqlConnection
                Dim myDataAdapter As New SqlDataAdapter
                SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
                'Open connection
                myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
                myDataAdapter.Fill(myDS)

                If myDS.Tables(0).Rows.Count > 0 Then
                    For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                        Hotelnames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("ServiceName").ToString(), myDS.Tables(0).Rows(i)("ServiceCode").ToString()))
                    Next
                End If
            End If
            Return Hotelnames
        Catch ex As Exception
            Return Hotelnames
        End Try

    End Function

End Class
