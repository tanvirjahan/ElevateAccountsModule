#Region "NameSpace"
Imports System
Imports System.Data
Imports System.Data.SqlClient
Imports System.Drawing.Color
Imports System.Collections.ArrayList
Imports System.Collections.Generic
#End Region

Partial Class TransportModule_OthPriceList1
    Inherits System.Web.UI.Page

#Region "Global Declaration"
    Dim objUtils As New clsUtils
    Dim ObjDate As New clsDateTime

    Dim strSqlQry As String
    Dim mySqlCmd As SqlCommand
    Dim mySqlReader As SqlDataReader
    Dim mySqlConn As SqlConnection


    Dim SqlCmd As SqlCommand
    Dim SqlReader As SqlDataReader
    Dim sqlTrans As SqlTransaction
    Dim StrQry As String
    Dim SqlCon As SqlConnection

    Dim gvRow1 As GridViewRow
    Dim myDataAdapter As SqlDataAdapter
    Dim dpFDate As New TextBox
    Dim dpTDate As New TextBox

    Private dt As New DataTable
    Private cnt As Long
    Private arr(1) As String
    Private arrRName(1) As String
#End Region

    '*** Dannny 20/05/2018>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
#Region "Private Sub ShowRecord(ByVal RefCode As String)"
    Private Sub ShowRecord(ByVal RefCode As String)
        Try
            mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))           'connection open
            mySqlCmd = New SqlCommand("Select * from trfplist_header Where tplistcode='" & RefCode & "'", mySqlConn)
            mySqlReader = mySqlCmd.ExecuteReader(CommandBehavior.CloseConnection)
            If mySqlReader.HasRows Then
                If mySqlReader.Read() = True Then


                    '*** Danny 02/05/2018>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                    Try
                        If IsDBNull(mySqlReader("PriceVATPer")) = False Then
                            Txt_VAT_Per.Text = DecRound(mySqlReader("PriceVATPer"))
                        End If

                        If mySqlReader("PriceWithTAX") = "1" Then
                            Chk_PriceIncludeVAT.Checked = True
                        Else
                            Chk_PriceIncludeVAT.Checked = False
                        End If
                    Catch ex As Exception

                    End Try
                   
                    '*** Danny 02/05/2018<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

                    If IsDBNull(mySqlReader("tplistcode")) = False Then
                        txtPlcCode.Value = mySqlReader("tplistcode")
                    End If



                    If mySqlReader("shifting") = "1" Then
                        chkshft.Checked = True
                    Else
                        chkshft.Checked = False
                    End If

                    If mySqlReader("approved") = "1" Then
                        chkapprove.Checked = True
                    Else
                        chkapprove.Checked = False
                    End If
                    If IsDBNull(mySqlReader("applicableto")) = False Then

                        txtApplicableTo.Text = mySqlReader("applicableto")
                    End If

                    If IsDBNull(mySqlReader("airportcode")) = False Then
                        txtairportcode.Text = mySqlReader("airportcode")
                        hdnairport.Value = mySqlReader("airportcode")

                        Dim strMealPlans As String = ""
                        Dim strCondition As String = ""
                        strMealPlans = mySqlReader("airportcode")
                        If strMealPlans.Length > 0 Then
                            Dim mString As String() = strMealPlans.Split(",")
                            For i As Integer = 0 To mString.Length - 1
                                If strCondition = "" Then
                                    strCondition = "'" & mString(i) & "'"
                                Else
                                    strCondition &= ",'" & mString(i) & "'"
                                End If
                            Next
                        End If

                        StrQry = "select distinct stuff((select  ',' + u.airportbordername   from airportbordersmaster u(nolock)  where u.airportbordercode =airportbordercode and u.airportbordercode in (" & strCondition & ")   group by airportbordername    for xml path('')),1,1,'')  airportbordername " _
                              & " from airportbordersmaster where  airportbordercode in (" & strCondition & ") "

                        txtairportname.Text = objUtils.ExecuteQueryReturnStringValuenew(Session("dbconnectionName"), StrQry) '"select rmtypname from partyrmtyp where partycode='" & hdnpartycode.Value & "' and rmtypcode in (" & strCondition & ") ")

                    End If

                    If IsDBNull(mySqlReader("sectorcode")) = False Then
                        txtairportcode.Text = IIf(chkshft.Checked = True, mySqlReader("sectorcode"), "")
                        hdnairport.Value = IIf(chkshft.Checked = True, mySqlReader("sectorcode"), "")


                        Dim strMealPlans1 As String = ""
                        Dim strCondition1 As String = ""
                        strMealPlans1 = mySqlReader("sectorcode")
                        If strMealPlans1.Length > 0 Then
                            Dim mString1 As String() = strMealPlans1.Split(",")
                            For i As Integer = 0 To mString1.Length - 1
                                If strCondition1 = "" Then
                                    strCondition1 = "'" & mString1(i) & "'"
                                Else
                                    strCondition1 &= ",'" & mString1(i) & "'"
                                End If
                            Next
                        End If

                        StrQry = "select distinct stuff((select  ',' + u.othtypname   from othtypmast u(nolock)  where u.othtypcode =othtypcode and u.othtypcode in (" & strCondition1 & ")   group by othtypname    for xml path('')),1,1,'')  othtypname " _
                              & " from othtypmast where  othtypcode in (" & strCondition1 & ") "

                        txtairportname.Text = objUtils.ExecuteQueryReturnStringValuenew(Session("dbconnectionName"), StrQry)
                    End If


                    If IsDBNull(mySqlReader("currcode")) = False Then
                        txtCurrcodenew.Text = mySqlReader("currcode")
                        txtCurrNamenew.Text = objUtils.GetDBFieldFromStringnew(Session("dbconnectionName"), "currmast", "currname", "currcode", mySqlReader("currcode"))
                    End If

                    If IsDBNull(mySqlReader("remarks")) = False Then
                        txtRemark.Value = mySqlReader("remarks")
                    End If



                End If



            End If


        Catch ex As Exception
            objUtils.WritErrorLog("OthPricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        Finally
            clsDBConnect.dbCommandClose(mySqlCmd)
            clsDBConnect.dbReaderClose(mySqlReader)
            clsDBConnect.dbConnectionClose(mySqlConn)
        End Try
    End Sub
#End Region

    Protected Sub btnSave_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnSave.Click
        Try
            'If Not Session("PlistSaved") = True Then ''this variable because response.redirect is causing a postback and saving twice

            Dim GvRow As GridViewRow
            If Page.IsValid = True Then
                If ViewState("pricelistState") = "New" Or ViewState("pricelistState") = "Edit" Or ViewState("pricelistState") = "Copy" Then
                    If ValidatePage() = False Then
                        Exit Sub
                    End If
                    If FindDatePeriod() = False Then

                        Exit Sub
                    End If

                    If Session("CountryList") = Nothing And Session("AgentList") = Nothing Then
                        ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Country and Agent Should not be Empty Please select .');", True)
                        Exit Sub
                    End If


                    mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))           'connection open
                    sqlTrans = mySqlConn.BeginTransaction           'SQL  Trans start

                    If ViewState("pricelistState") = "New" Or ViewState("pricelistState") = "Copy" Then
                        Dim optionval As String
                        Dim optionName As String

                        optionName = "TRFPLIST"
                        optionval = objUtils.GetAutoDocNo(optionName, mySqlConn, sqlTrans)
                        txtPlcCode.Value = optionval.Trim
                        mySqlCmd = New SqlCommand("sp_add_trfPListh", mySqlConn, sqlTrans)
                    ElseIf ViewState("pricelistState") = "Edit" Then

                        'Inserting Into Logs
                        mySqlCmd = New SqlCommand("sp_transferpriceslist_logs", mySqlConn, sqlTrans)
                        mySqlCmd.CommandType = CommandType.StoredProcedure
                        mySqlCmd.Parameters.Add(New SqlParameter("@plistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value.Trim, String)
                        mySqlCmd.Parameters.Add(New SqlParameter("@userlogged", SqlDbType.VarChar, 10)).Value = CType(Session("GlobalUserName"), String)
                        mySqlCmd.ExecuteNonQuery()
                        mySqlCmd = New SqlCommand("sp_mod_trfplisthnew", mySqlConn, sqlTrans)
                    End If

                    mySqlCmd.CommandType = CommandType.StoredProcedure
                    mySqlCmd.Parameters.Add(New SqlParameter("@tplistcd", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value.Trim, String)


                    'If CType(ddlSPType.Items(ddlSPType.SelectedIndex).Text.Trim, String) = "[Select]" Then
                    '    mySqlCmd.Parameters.Add(New SqlParameter("@tsellcd", SqlDbType.VarChar, 20)).Value = DBNull.Value
                    'Else
                    '    mySqlCmd.Parameters.Add(New SqlParameter("@tsellcd", SqlDbType.VarChar, 20)).Value = CType(ddlSPType.Items(ddlSPType.SelectedIndex).Text.Trim, String)
                    'End If

                    If CType(txtCurrcodenew.Text.Trim, String) = "" Then
                        mySqlCmd.Parameters.Add(New SqlParameter("@currcd", SqlDbType.VarChar, 20)).Value = DBNull.Value
                    Else
                        mySqlCmd.Parameters.Add(New SqlParameter("@currcd", SqlDbType.VarChar, 20)).Value = CType(txtCurrcodenew.Text.Trim, String)
                    End If

                    '**************************** Setting the MaX DATE and Min Date fromt the GRID CONTROL ***********************
                    Call SetDate()

                    mySqlCmd.Parameters.Add(New SqlParameter("@frmdt", SqlDbType.DateTime)).Value = ObjDate.ConvertDateromTextBoxToDatabase(ViewState("TempFrmDt"))
                    mySqlCmd.Parameters.Add(New SqlParameter("@todt", SqlDbType.DateTime)).Value = ObjDate.ConvertDateromTextBoxToDatabase(ViewState("TempToDt"))


                    If chkshft.Checked = False Then

                        mySqlCmd.Parameters.Add(New SqlParameter("@airportcd", SqlDbType.VarChar, 8000)).Value = CType(txtairportcode.Text, String)

                    Else
                        mySqlCmd.Parameters.Add(New SqlParameter("@airportcd", SqlDbType.VarChar, 8000)).Value = ""
                    End If



                    mySqlCmd.Parameters.Add(New SqlParameter("@remarks", SqlDbType.Text)).Value = CType(txtRemark.Value.Trim, String)

                    If ViewState("pricelistState") = "New" Or ViewState("pricelistState") = "Copy" Then
                        mySqlCmd.Parameters.Add(New SqlParameter("@adduser", SqlDbType.VarChar, 10)).Value = CType(Session("GlobalUserName"), String)
                    Else
                        mySqlCmd.Parameters.Add(New SqlParameter("@moduser", SqlDbType.VarChar, 10)).Value = CType(Session("GlobalUserName"), String)
                    End If



                    If chkshft.Checked = True Then
                        mySqlCmd.Parameters.Add(New SqlParameter("@shift", SqlDbType.Int)).Value = 1
                    ElseIf chkshft.Checked = False Then
                        mySqlCmd.Parameters.Add(New SqlParameter("@shift", SqlDbType.Int)).Value = 0
                    End If
                    If chkapprove.Checked = True Then
                        mySqlCmd.Parameters.Add(New SqlParameter("@approved", SqlDbType.Int)).Value = 1
                    Else
                        mySqlCmd.Parameters.Add(New SqlParameter("@approved", SqlDbType.Int)).Value = 0
                    End If

                    'sector code 
                    If chkshft.Checked = False Then
                        mySqlCmd.Parameters.Add(New SqlParameter("@sectorcd", SqlDbType.VarChar, 20)).Value = DBNull.Value
                    Else
                        mySqlCmd.Parameters.Add(New SqlParameter("@sectorcd", SqlDbType.VarChar, 20)).Value = CType(txtairportcode.Text, String)
                    End If
                    mySqlCmd.Parameters.Add(New SqlParameter("@applicableto", SqlDbType.VarChar, 8000)).Value = CType(txtApplicableTo.Text.Trim, String)

                    '@chkMarkUp
                    '*** Danny 02/05/2018>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                    mySqlCmd.Parameters.Add(New SqlParameter("@PriceVATPer", SqlDbType.Decimal)).Value = Txt_VAT_Per.Text.Trim
                    If Chk_PriceIncludeVAT.Checked = True Then
                        mySqlCmd.Parameters.Add(New SqlParameter("@PriceWithTAX", SqlDbType.Int)).Value = 1
                    Else
                        mySqlCmd.Parameters.Add(New SqlParameter("@PriceWithTAX", SqlDbType.Int)).Value = 0
                    End If
                    '*** Danny 02/05/2018<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
                    mySqlCmd.ExecuteNonQuery()
                    mySqlCmd.Dispose()
                    '-----------------------------------------------------------


                    mySqlCmd = New SqlCommand("DELETE FROM trfplist_countries  Where tplistcode='" & CType(txtPlcCode.Value.Trim, String) & "'", mySqlConn, sqlTrans)
                    mySqlCmd.CommandType = CommandType.Text
                    mySqlCmd.ExecuteNonQuery()

                    mySqlCmd = New SqlCommand("DELETE FROM trfplist_agents  Where tplistcode='" & CType(txtPlcCode.Value.Trim, String) & "'", mySqlConn, sqlTrans)
                    mySqlCmd.CommandType = CommandType.Text
                    mySqlCmd.ExecuteNonQuery()


                    mySqlCmd = New SqlCommand("DELETE FROM trfplist_detail  Where tplistcode='" & CType(txtPlcCode.Value.Trim, String) & "'", mySqlConn, sqlTrans)
                    mySqlCmd.CommandType = CommandType.Text
                    mySqlCmd.ExecuteNonQuery()

                    mySqlCmd = New SqlCommand("DELETE FROM trfplist_dates  Where tplistcode='" & CType(txtPlcCode.Value.Trim, String) & "'", mySqlConn, sqlTrans)
                    mySqlCmd.CommandType = CommandType.Text
                    mySqlCmd.ExecuteNonQuery()



                    '----------------------------------- Inserting Data To Dates Table
                    For Each GvRow In grdDates.Rows
                        dpFDate = GvRow.FindControl("txtfromDate")
                        dpTDate = GvRow.FindControl("txtToDate")

                        If dpFDate.Text <> "" And dpTDate.Text <> "" Then
                            mySqlCmd = New SqlCommand("sp_add_trfplisth_dates", mySqlConn, sqlTrans)
                            mySqlCmd.CommandType = CommandType.StoredProcedure
                            mySqlCmd.Parameters.Add(New SqlParameter("@tplistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value.Trim, String)
                            mySqlCmd.Parameters.Add(New SqlParameter("@frmdate", SqlDbType.DateTime)).Value = ObjDate.ConvertDateromTextBoxToDatabase(dpFDate.Text)
                            mySqlCmd.Parameters.Add(New SqlParameter("@todate", SqlDbType.DateTime)).Value = ObjDate.ConvertDateromTextBoxToDatabase(dpTDate.Text)

                            mySqlCmd.ExecuteNonQuery()
                        End If
                    Next

                    '----- update the header table with the min max date of dates table 
                    mySqlCmd = New SqlCommand("sp_upd_min_max_dates", mySqlConn, sqlTrans)
                    mySqlCmd.CommandType = CommandType.StoredProcedure
                    mySqlCmd.Parameters.Add(New SqlParameter("@tplistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value.Trim, String)
                    mySqlCmd.ExecuteNonQuery()



                    Dim j As Long = 1
                    Dim txt As TextBox
                    Dim cnt As Long
                    Dim srno As Long = 0
                    Dim hotelcategory As String = ""
                    j = 0

                    grdtransferrates.Visible = True
                    cnt = grdtransferrates.Columns.Count
                    Dim n As Long = 0
                    Dim k As Long = 0
                    Dim a As Long = cnt - 10
                    Dim b As Long = 0
                    Dim header As Long = 0
                    Dim heading(cnt + 1) As String
                    Dim arrlist As String()
                    '----------------------------------------------------------------------------
                    '           Stoaring heading column values in the array
                    ' For header = grdtransferrates.Columns.Count - 1 To 3 Step -1
                    For header = 0 To cnt - 4
                        txt = grdtransferrates.HeaderRow.FindControl("txtHead" & header)
                        heading(header) = txt.Text
                    Next
                    '----------------------------------------------------------------------------
                    Dim txttrftypecode As TextBox

                    j = 0
                    n = 0
                    'm = 0
                    b = 0
                    'chksel = gvRow1.FindControl("chkSelect")

                    Dim dt_InsertData As New DataTable


                    dt_InsertData.Columns.Add("tplistcode")
                    dt_InsertData.Columns.Add("sectorcode")
                    dt_InsertData.Columns.Add("othgrpcode")
                    dt_InsertData.Columns.Add("cartype")
                    dt_InsertData.Columns.Add("price")
                    dt_InsertData.Columns.Add("Pkg")
                    dt_InsertData.Columns.Add("PriceTaxableValue")
                    dt_InsertData.Columns.Add("PriceVATValue")
                    'dt_InsertData.Columns.Add("PriceVATPer")
                    'dt_InsertData.Columns.Add("PriceWithTAX")


                    Dim groupcode As String = objUtils.ExecuteQueryReturnStringValuenew(Session("dbconnectionName"), "select option_selected from reservation_parameters where param_id=1001")
                    Dim m As Long = 0
                    For Each GvRow In grdtransferrates.Rows
                        If n = 0 Then
                            For j = 0 To cnt - 4
                                txt = GvRow.FindControl("txt" & j)
                                txttrftypecode = GvRow.FindControl("txttrftypecode")
                                'If heading(j) = "From Date" Or heading(j) = "To Date" Or heading(j) = "Pkg" Then
                                If txt.Text <> "" Then
                                    '*** Danny Commented 19/05/2018>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                    '' ''mySqlCmd = New SqlCommand("sp_add_TrfplistCostd", mySqlConn, sqlTrans)
                                    '' ''mySqlCmd.CommandType = CommandType.StoredProcedure
                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@tplistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value.Trim, String)
                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@othseccode", SqlDbType.VarChar, 20)).Value = CType(txttrftypecode.Text, String)


                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@othgrpcode", SqlDbType.VarChar, 20)).Value = CType(groupcode, String)
                                    '' ''arrlist = heading(j).Split("-")
                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@cartype", SqlDbType.VarChar, 20)).Value = CType(arrlist(0), String)
                                    ' '' ''txt = GvRow.FindControl("txt" & j)
                                    '' ''If txt.Text = "" Then
                                    '' ''    mySqlCmd.Parameters.Add(New SqlParameter("@tcostprice", SqlDbType.Decimal, 18, 3)).Value = DBNull.Value
                                    '' ''Else
                                    '' ''    mySqlCmd.Parameters.Add(New SqlParameter("@tcostprice", SqlDbType.Decimal, 18, 3)).Value = CType(txt.Text.Trim, Decimal)
                                    '' ''End If
                                    ' '' ''pkg
                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@pkg", SqlDbType.Int)).Value = 1

                                    '' ''mySqlCmd.ExecuteNonQuery()
                                    '*** Danny Commented 19/05/2018<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

                                    Dim NewRow As DataRow = dt_InsertData.NewRow
                                    NewRow("tplistcode") = CType(txtPlcCode.Value.Trim, String)
                                    NewRow("sectorcode") = CType(txttrftypecode.Text, String)
                                    NewRow("othgrpcode") = CType(groupcode, String)
                                    arrlist = heading(j).Split("-")
                                    NewRow("cartype") = CType(arrlist(0), String)
                                    NewRow("price") = CType(txt.Text.Trim, Decimal)
                                    NewRow("Pkg") = 1

                                    If Chk_PriceIncludeVAT.Checked = True Then
                                        Dim PriceTaxableValue As Decimal = CType(txt.Text.Trim, Decimal) / (1 + (CType(Txt_VAT_Per.Text.Trim, Decimal) / 100))
                                        NewRow("PriceTaxableValue") = DecRound(PriceTaxableValue)
                                        PriceTaxableValue = CType(txt.Text.Trim, Decimal) - PriceTaxableValue
                                        NewRow("PriceVATValue") = DecRound(PriceTaxableValue)
                                        'NewRow("PriceWithTAX") = 1
                                    Else
                                        NewRow("PriceTaxableValue") = DecRound(CType(txt.Text.Trim, Decimal))
                                        NewRow("PriceVATValue") = DecRound(CType(txt.Text.Trim, Decimal) * ((CType(Txt_VAT_Per.Text.Trim, Decimal) / 100)))
                                    End If
                                    'NewRow("PriceVATPer") = Txt_VAT_Per.Text.Trim


                                    dt_InsertData.Rows.Add(NewRow)




                                End If
                            Next
                            m = j
                        Else
                            k = 0
                            For j = n To (m + n) - 1
                                txt = GvRow.FindControl("txt" & j)
                                txttrftypecode = GvRow.FindControl("txttrftypecode")
                                'if heading(k) = "From Date" Or heading(k) = "To Date" Or heading(k) = "Pkg" Then
                                If txt.Text <> "" Then
                                    '*** Danny Commented 19/05/2018>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                    '' ''mySqlCmd = New SqlCommand("sp_add_TrfplistCostd", mySqlConn, sqlTrans)
                                    '' ''mySqlCmd.CommandType = CommandType.StoredProcedure
                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@tplistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value.Trim, String)
                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@othseccode", SqlDbType.VarChar, 20)).Value = CType(txttrftypecode.Text, String)


                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@othgrpcode", SqlDbType.VarChar, 20)).Value = CType(groupcode, String)


                                    '' ''arrlist = heading(k).Split("-")
                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@cartype", SqlDbType.VarChar, 20)).Value = CType(arrlist(0), String)
                                    ' '' ''txt = GvRow.FindControl("txt" & j)
                                    '' ''If txt.Text = "" Then
                                    '' ''    mySqlCmd.Parameters.Add(New SqlParameter("@tcostprice", SqlDbType.Decimal, 18, 3)).Value = DBNull.Value
                                    '' ''Else
                                    '' ''    mySqlCmd.Parameters.Add(New SqlParameter("@tcostprice", SqlDbType.Decimal, 18, 3)).Value = CType(txt.Text.Trim, Decimal)
                                    '' ''End If
                                    ' '' ''pkg
                                    '' ''mySqlCmd.Parameters.Add(New SqlParameter("@pkg", SqlDbType.Int)).Value = 1


                                    '' ''mySqlCmd.ExecuteNonQuery()

                                    '*** Danny Commented 19/05/2018<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

                                    Dim NewRow As DataRow = dt_InsertData.NewRow
                                    NewRow("tplistcode") = CType(txtPlcCode.Value.Trim, String)
                                    NewRow("sectorcode") = CType(txttrftypecode.Text, String)
                                    NewRow("othgrpcode") = CType(groupcode, String)
                                    arrlist = heading(k).Split("-")
                                    NewRow("cartype") = CType(arrlist(0), String)
                                    NewRow("price") = CType(txt.Text.Trim, Decimal)
                                    NewRow("Pkg") = 1

                                    If Chk_PriceIncludeVAT.Checked = True Then
                                        Dim PriceTaxableValue As Decimal = CType(txt.Text.Trim, Decimal) / (1 + (CType(Txt_VAT_Per.Text.Trim, Decimal) / 100))
                                        NewRow("PriceTaxableValue") = DecRound(PriceTaxableValue)
                                        PriceTaxableValue = CType(txt.Text.Trim, Decimal) - PriceTaxableValue
                                        NewRow("PriceVATValue") = DecRound(PriceTaxableValue)
                                        'NewRow("PriceWithTAX") = 1
                                    Else
                                        NewRow("PriceTaxableValue") = DecRound(CType(txt.Text.Trim, Decimal))
                                        NewRow("PriceVATValue") = DecRound(CType(txt.Text.Trim, Decimal) * ((CType(Txt_VAT_Per.Text.Trim, Decimal) / 100)))
                                    End If
                                    'NewRow("PriceVATPer") = Txt_VAT_Per.Text.Trim

                                    dt_InsertData.Rows.Add(NewRow)


                                End If
                                k = k + 1
                            Next
                        End If
                        b = j
                        n = j
                    Next
                    Using bulkCopy As SqlBulkCopy = New SqlBulkCopy(mySqlConn, SqlBulkCopyOptions.Default, sqlTrans)

                        bulkCopy.DestinationTableName = "dbo.trfplist_detail"

                        'Try
                        ' Write from the source to the destination.
                        bulkCopy.WriteToServer(dt_InsertData)

                        'Catch ex As Exception
                        '    Console.WriteLine(ex.Message)
                        'End Try
                    End Using
                    If wucCountrygroup.checkcountrylist.ToString <> "" Then

                        ''Value in hdn variable , so splting to get string correctly
                        Dim arrcountry As String() = wucCountrygroup.checkcountrylist.ToString.Trim.Split(",")
                        For i = 0 To arrcountry.Length - 1

                            If arrcountry(i) <> "" Then


                                mySqlCmd = New SqlCommand("sp_add_trfplist_countries", mySqlConn, sqlTrans)
                                mySqlCmd.CommandType = CommandType.StoredProcedure


                                mySqlCmd.Parameters.Add(New SqlParameter("@eplistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value, String)
                                mySqlCmd.Parameters.Add(New SqlParameter("@countrycode", SqlDbType.VarChar, 20)).Value = CType(arrcountry(i), String)

                                mySqlCmd.ExecuteNonQuery()
                                mySqlCmd.Dispose() 'command disposed
                            End If
                        Next

                    End If

                    If wucCountrygroup.checkagentlist.ToString <> "" Then

                        ''Value in hdn variable , so splting to get string correctly
                        Dim arragents As String() = wucCountrygroup.checkagentlist.ToString.Trim.Split(",")
                        For i = 0 To arragents.Length - 1

                            If arragents(i) <> "" Then

                                mySqlCmd = New SqlCommand("sp_add_trfplist_agents", mySqlConn, sqlTrans)
                                mySqlCmd.CommandType = CommandType.StoredProcedure


                                mySqlCmd.Parameters.Add(New SqlParameter("@eplistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value, String)
                                mySqlCmd.Parameters.Add(New SqlParameter("@agentcode", SqlDbType.VarChar, 20)).Value = CType(arragents(i), String)

                                mySqlCmd.ExecuteNonQuery()
                                mySqlCmd.Dispose() 'command disposed
                            End If
                        Next
                    End If

                    '---------------------------------------------End of save/edit/copy------------------------
                ElseIf ViewState("pricelistState") = "Delete" Then
                    mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))           'connection open
                    sqlTrans = mySqlConn.BeginTransaction           'SQL  Trans start

                    'Inserting Into Logs
                    mySqlCmd = New SqlCommand("sp_transferpriceslist_logs", mySqlConn, sqlTrans)
                    mySqlCmd.CommandType = CommandType.StoredProcedure
                    mySqlCmd.Parameters.Add(New SqlParameter("@plistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value.Trim, String)
                    mySqlCmd.Parameters.Add(New SqlParameter("@userlogged", SqlDbType.VarChar, 10)).Value = CType(Session("GlobalUserName"), String)
                    mySqlCmd.ExecuteNonQuery()

                    'delete of main tbl to be written
                    mySqlCmd = New SqlCommand("sp_del_Trfplisth", mySqlConn, sqlTrans)
                    mySqlCmd.CommandType = CommandType.StoredProcedure
                    mySqlCmd.Parameters.Add(New SqlParameter("@tplistcode", SqlDbType.VarChar, 20)).Value = CType(txtPlcCode.Value.Trim, String)
                    mySqlCmd.ExecuteNonQuery()

                End If

            End If
            sqlTrans.Commit()    'SQl Tarn Commit
            clsDBConnect.dbSqlTransation(sqlTrans)              ' sql Transaction disposed 
            clsDBConnect.dbCommandClose(mySqlCmd)               'sql command disposed
            clsDBConnect.dbConnectionClose(mySqlConn)           'connection close
            Dim strscript As String = ""
            strscript = "window.opener.__doPostBack('TransferPriceListWindowPostBack', '');window.opener.focus();window.close();"
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "popup", strscript, True)

        Catch ex As Exception
            If mySqlConn.State = ConnectionState.Open Then
                sqlTrans.Rollback()
            End If
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("OthPriceList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
    End Sub



#Region " Validate Page"
    Public Function ValidatePage() As Boolean
        Dim strValue As String = ""
        Dim strErrorstr As String = ""
        Try

            If txtairportcode.Text = "" Then
                'ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Please select Airport or Sector Name.');", True)
                ''   ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "FocusScr", "WebForm_AutoFocus('" + ddlSPTypeCD.ClientID + "');", True)
                'Return False
                'Exit Function
                strErrorstr = "Please select Airport or Sector Name.\n"
                txtairportcode.BackColor = Coral
            End If
            If txtairportname.Text = "" Then
                strErrorstr = "Please select Airport or Sector Name.\n"
                txtairportname.BackColor = Coral
            End If
            'If txtsuppname.Text = "" Then
            '    strErrorstr = "Please select Supplier Name.\n"
            '    txtsuppname.BackColor = Coral
            'End If
            'If txtsuppcode.Text = "" Then
            '    'ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Please select Supplier.');", True)
            '    strErrorstr = strErrorstr + "Please select Supplier.\n"
            '    txtairportcode.BackColor = Coral
            '    '   ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "FocusScr", "WebForm_AutoFocus('" + ddlSPTypeCD.ClientID + "');", True)
            '    'Return False
            '    'Exit Function
            'End If

            If Val(Txt_VAT_Per.Text) = 0 Then
                strErrorstr = strErrorstr + "Please enter VAT %.\n"
                Txt_VAT_Per.BackColor = Coral
            ElseIf Val(Txt_VAT_Per.Text) > 100 Then
                strErrorstr = strErrorstr + "Invalid VAT %.\n"
                Txt_VAT_Per.BackColor = Coral
            End If

            'If Val(Txt_VAT_Per.Text) = 0 Then
            '    strErrorstr = strErrorstr + "Please enter VAT %.<br>"
            '    Txt_VAT_Per.BackColor = Coral
            'End If
            If strErrorstr.Trim.Length > 0 Then
                ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" + strErrorstr + "');", True)
                Return False
                Exit Function
            End If

            ValidatePage = True

        Catch ex As Exception
            objUtils.WritErrorLog("OthPricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
            ValidatePage = False
        End Try

    End Function
#End Region
    '*** Dannny 20/05/2018<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
#Region "TextLock"
    Public Sub TextLock(ByVal txtbox As TextBox)
        txtbox.Attributes.Add("onKeyPress", "return chkTextLock(event)")
        txtbox.Attributes.Add("onKeyDown", "return chkTextLock1(event)")
        txtbox.Attributes.Add("onKeyUp", "return chkTextLock(event)")
    End Sub
#End Region
#Region "related to user control wucCountrygroup"
    Protected Sub btnvsprocess_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnvsprocess.Click
        wucCountrygroup.fnbtnVsProcess(txtvsprocesssplit, dlList)
    End Sub
    Protected Sub lnkCodeAndValue_Click(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            wucCountrygroup.fnCodeAndValue_ButtonClick(sender, e, dlList, Nothing, Nothing)
        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("OthPriceList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
    End Sub
    Protected Sub lbClose_Click(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            wucCountrygroup.fnCloseButtonClick(sender, e, dlList)
        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("OthPriceList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
    End Sub

    <System.Web.Script.Services.ScriptMethod()> _
    <System.Web.Services.WebMethod()> _
    Public Shared Function GetAgentListSearch(ByVal prefixText As String) As List(Of String)

        Dim strSqlQry As String = ""
        Dim myDS As New DataSet
        Dim lsAgentNames As New List(Of String)
        Dim lsCountryList As String
        Try

            strSqlQry = "select a.agentname, a.ctrycode from agentmast a where a.active=1 and a.agentname like  '%" & Trim(prefixText) & "%'"

            'Dim wc As New PriceListModule_Countrygroup
            'wc = wucCountrygroup
            'lsCountryList = wc.fnGetSelectedCountriesList

            If HttpContext.Current.Session("SelectedCountriesList_WucCountryGroupUserControl") IsNot Nothing Then
                lsCountryList = HttpContext.Current.Session("SelectedCountriesList_WucCountryGroupUserControl").ToString.Trim
                'If HttpContext.Current.Session("AllCountriesList_WucCountryGroupUserControl") IsNot Nothing Then 'changed by mohamed on 03/10/2016 - instead of selected, used all
                'lsCountryList = HttpContext.Current.Session("AllCountriesList_WucCountryGroupUserControl").ToString.Trim
                If lsCountryList <> "" Then
                    'strSqlQry += " and a.ctrycode in (" & lsCountryList & ")" 'changed by mohamed on 03/10/2016 -'commented this line to show all the agents.
                End If
            End If

            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)

            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1
                    'lsAgentNames.Add(myDS.Tables(0).Rows(i)("agentname").ToString())
                    lsAgentNames.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("agentname").ToString(), myDS.Tables(0).Rows(i)("ctrycode").ToString()))
                Next
            End If

            Return lsAgentNames
        Catch ex As Exception

            Return lsAgentNames
        End Try

    End Function
#End Region
#Region "Protected Sub Page_Init(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Init"

   
    Protected Sub imgStayAdd_Click(ByVal sender As Object, ByVal e As System.EventArgs)


        'Try
        '    Dim row As GridViewRow = CType((CType(sender, ImageButton)).NamingContainer, GridViewRow)
        '    GenerateGridColumns("ADD", 0)
        '    row.FindControl("imgStayAdd").Visible = False
        '    Dim txtfromdate As TextBox
        '    txtfromdate = TryCast(grdDates.Rows(grdDates.Rows.Count - 1).FindControl("txtfromdate"), TextBox)
        '    txtfromdate.Focus()
        'Catch ex As Exception
        '    ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
        '    objUtils.WritErrorLog("ContractCommission.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        'End Try


        Dim count As Integer
        Dim GVRow As GridViewRow

        Dim gvchildage As GridView

        gvchildage = DirectCast(DirectCast(DirectCast(sender, ImageButton).NamingContainer, GridViewRow).NamingContainer, GridView)

        count = gvchildage.Rows.Count + 1

        'count = grdDates.Rows.Count + 1
        Dim fDate(count) As String
        Dim tDate(count) As String
        Dim excl(count) As String
        Dim n As Integer = 0
        Dim dpFDate As TextBox
        Dim dpTDate As TextBox
        Dim lblseason As Label

        Try
            For Each GVRow In grdDates.Rows
                dpFDate = GVRow.FindControl("txtfromDate")
                fDate(n) = CType(dpFDate.Text, String)
                dpTDate = GVRow.FindControl("txtToDate")
                tDate(n) = CType(dpTDate.Text, String)
                'lblseason = GVRow.FindControl("lblseason")
                'excl(n) = CType(lblseason.Text, String)
                n = n + 1
            Next
            fillDategrd(grdDates, False, grdDates.Rows.Count + 1)
            Dim i As Integer = n
            n = 0
            For Each GVRow In grdDates.Rows
                If n = i Then
                    Exit For
                End If
                dpFDate = GVRow.FindControl("txtfromDate")
                dpFDate.Text = fDate(n)
                dpTDate = GVRow.FindControl("txtToDate")
                dpTDate.Text = tDate(n)
                'lblseason = GVRow.FindControl("lblseason")
                'lblseason.Text = excl(n)

                n = n + 1
            Next

            'For Each GVRow In grdDates.Rows
            '    lblseason = GVRow.FindControl("lblseason")
            '    If lblseason.Text = "" Then
            '        lblseason.Text = txtseasonname.Text
            '    End If
            'Next

            Dim txtStayFromDt As TextBox
            txtStayFromDt = TryCast(grdDates.Rows(grdDates.Rows.Count - 1).FindControl("txtfromDate"), TextBox)
            txtStayFromDt.Focus()

        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            ' .writerrorlog(Server.MapPath("Errorlog.txt"), ex.ToString, 1, 1)
        End Try
    End Sub
#Region "Public Sub fillgrd(ByVal grd As GridView, Optional ByVal blnload As Boolean = False, Optional ByVal count As Integer = 1)"
    Public Sub fillDategrd(ByVal grd As GridView, Optional ByVal blnload As Boolean = False, Optional ByVal count As Integer = 1)
        Dim lngcnt As Long
        If blnload = True Then
            lngcnt = 1
        Else
            lngcnt = count
        End If

        grd.DataSource = CreateDataSource(lngcnt)
        grd.DataBind()
        grd.Visible = True
    End Sub
#End Region
#Region "Private Function CreateDataSource(ByVal lngcount As Long) As DataView"
    Private Function CreateDataSource(ByVal lngcount As Long) As DataView
        Dim dt As DataTable
        Dim dr As DataRow
        Dim i As Integer
        dt = New DataTable
        dt.Columns.Add(New DataColumn("SrNo", GetType(Integer)))

        For i = 1 To lngcount
            dr = dt.NewRow()
            dr(0) = i
            dt.Rows.Add(dr)
        Next
        'return a DataView to the DataTable
        CreateDataSource = New DataView(dt)
        'End If
    End Function
#End Region
    Protected Sub imgSclose_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs)

        'Try
        '    Dim row As GridViewRow = CType((CType(sender, ImageButton)).NamingContainer, GridViewRow)
        '    GenerateGridColumns("DELETE", row.RowIndex)
        'Catch ex As Exception
        '    ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
        '    objUtils.WritErrorLog("ContractCommission.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        'End Try


        Dim count As Integer

        Dim gvchildage As GridView

        gvchildage = DirectCast(DirectCast(DirectCast(sender, ImageButton).NamingContainer, GridViewRow).NamingContainer, GridView)
        Dim row As GridViewRow = CType((CType(sender, ImageButton)).NamingContainer, GridViewRow)
        count = gvchildage.Rows.Count + 1

        Dim GVRow As GridViewRow
        '  count = grdDates.Rows.Count + 1
        Dim fDate(count) As String
        Dim tDate(count) As String
        Dim excl(count) As String
        Dim n As Integer = 0
        Dim dpFDate As TextBox
        Dim dpTDate As TextBox
        Dim lblseason As Label

        Dim delrows(count) As String
        Dim deletedrow As Integer = 0
        Dim k As Integer = 0

        Try
            For Each GVRow In grdDates.Rows
                '  chkSelect = GVRow.FindControl("chkSelect")
                'If chkSelect.Checked = False Then
                If k <> row.RowIndex Then
                    dpFDate = GVRow.FindControl("txtfromDate")
                    fDate(n) = CType(dpFDate.Text, String)
                    dpTDate = GVRow.FindControl("txtToDate")
                    tDate(n) = CType(dpTDate.Text, String)
                    n = n + 1
                Else
                    deletedrow = deletedrow + 1
                End If

                k = k + 1
            Next

            count = n
            If count = 0 Then
                count = 1
            End If

            If grdDates.Rows.Count > 1 Then
                fillDategrd(grdDates, False, grdDates.Rows.Count - deletedrow)
            Else
                fillDategrd(grdDates, False, grdDates.Rows.Count)
            End If


            Dim i As Integer = n
            n = 0
            For Each GVRow In grdDates.Rows
                If GVRow.RowIndex < count Then
                    dpFDate = GVRow.FindControl("txtfromDate")
                    dpFDate.Text = fDate(n)
                    dpTDate = GVRow.FindControl("txtToDate")
                    dpTDate.Text = tDate(n)
                    'lblseason = GVRow.FindControl("lblseason")
                    'lblseason.Text = excl(n)
                    n = n + 1
                End If
            Next

        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            ' .writerrorlog(Server.MapPath("Errorlog.txt"), ex.ToString, 1, 1)
        End Try


    End Sub
    Protected Sub Page_Init(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Init
        Try

            If IsPostBack = False Then
                'Session ("OthPLFilter")
                Dim strqry As String = ""
                Dim strOption As String = ""
                Dim strtitle As String = ""
                Dim strSpType As String = ""

                Session("GV_OthPLData") = Nothing

                grdDates.Visible = True
                fillDategrd(grdDates, True)


                ViewState.Add("pricelistState", Request.QueryString("State"))
                ViewState.Add("RefCode", Request.QueryString("RefCode"))

                'If (Session("OthPListFilter") <> Nothing And Session("OthPListFilter") <> "OTH") Then

                '    strOption = objUtils.GetDBFieldFromStringnew(Session("dbconnectionName"), "reservation_parameters", "option_selected", "param_id", Session("OthPListFilter"))

                '             Dim sptype As String = ""
                '    sptype = objUtils.GetDBFieldFromStringnew(Session("dbconnectionName"), "reservation_parameters", "option_selected", "param_id", strSpType)
                '    If sptype <> "" Then
                '        ddlSPTypeName.Value = sptype
                '        ddlSPType.Value = ddlSPTypeName.Items(ddlSPTypeName.SelectedIndex).Text
                '    End If




                '    strqry = "select othgrpcode,othgrpname from othgrpmast where active=1 And othgrpcode=(Select Option_Selected From Reservation_ParaMeters" & _
                '        " Where Param_Id='" & Session("OthPListFilter") & "') order by othgrpcode"

                'ElseIf Session("OthPListFilter") = "OTH" Then
                '    Dim sptypeQry As String = ""
                '    sptypeQry = "select othgrpcode , othgrpname  from othgrpmast where active=1 and othgrpcode in (select option_selected from reservation_parameters where param_id=1001)"
                '      strtitle = "Other Service "
                '    strqry = "select othgrpcode , othgrpname  from othgrpmast where active=1 and othgrpcode in (select option_selected from reservation_parameters where param_id=1001)"

                'End If

                If Request.QueryString("State") = "New" Then
                    Page.Title = Page.Title + " " + "New " + strtitle + " Transfer Price List"

                    txtCurrcodenew.Text = objUtils.ExecuteQueryReturnStringValuenew(Session("dbconnectionName"), "select option_selected    from reservation_parameters where param_id =928")
                    txtCurrNamenew.Text = objUtils.GetDBFieldFromStringnew(Session("dbconnectionName"), "currmast", "currname", "currcode", txtCurrcodenew.Text)

                ElseIf Request.QueryString("State") = "Copy" Then
                    Page.Title = Page.Title + " " + "Copy " + strtitle + " Transfer Price List"
                ElseIf Request.QueryString("State") = "Edit" Then
                    Page.Title = Page.Title + " " + "Edit " + strtitle + " Transfer Price List"
                ElseIf Request.QueryString("State") = "View" Then
                    Page.Title = Page.Title + " " + "View" + strtitle + " Transfer Price List"
                ElseIf Request.QueryString("State") = "Delete" Then
                    Page.Title = Page.Title + " " + "Delete " + strtitle + " Transfer Price List"
                End If

                grdDates.Visible = True
                fillDategrd(grdDates, True)

                Dim s As String = ""
              

                txtconnection.Value = Session("dbconnectionName")
              
                btnclearprice.Attributes.Add("onclick", "javascript:if(confirm('Are you sure you want to clear prices?')==false)return false;")

           

                btnCancel.Attributes.Add("onclick", "javascript:if(confirm('Are you sure you want to cancel?')==false)return false;")

                If ViewState("pricelistState") = "New" Then
                    '    btnGenerate.Attributes.Add("onclick", "return FormValidation('New')")
                    Dim obj As New EncryptionDecryption

                    SetFocus(ddlSPType)

                    lblHeading.Text = "Add New " + strtitle + " Transfer Price List"

                    btnGenerate.Attributes.Add("onclick", "return FormValidation('Edit')")
                ElseIf ViewState("pricelistState") = "Edit" Or ViewState("OthpricelistState") = "Copy" Then
                    btnGenerate.Attributes.Add("onclick", "return FormValidation('Edit')")
                    'SetFocus(ddlMarketCode)
                    ' ShowRecord(ViewState("pricelistState"))
                    lblHeading.Text = "Edit " + strtitle + " Transfer Price List"
                ElseIf ViewState("pricelistState") = "View" Then
                    '   ShowRecord(ViewState("OthpricelistRefCode"))
                ElseIf ViewState("pricelistState") = "Delete" Then
                    '  ShowRecord(ViewState("OthpricelistRefCode"))
                End If
                If ViewState("pricelistState") = "Copy" Then
                    txtPlcCode.Value = ""
                End If
                DisableAllControls()
            

                chkshft.Attributes.Add("onChange", "showsector('" & chkshft.ClientID & "')")

                Dim typ As Type
                typ = GetType(DropDownList)

                If (Page.ClientScript.IsClientScriptIncludeRegistered(typ, "TADDScript.js")) = False Then
                    Page.ClientScript.RegisterClientScriptInclude(typ, "TADDScript.js", "TADDScript.js")

                   

                End If
                btnCancel.Attributes.Add("onclick", "javascript:if(confirm('Are you sure you want to cancel?')==false)return false;")
            Else
                If Session("GV_OthPLData") Is Nothing = False Then
                    dt = Session("GV_OthPLData")


                  Dim fld2 As String = ""
                    Dim col As DataColumn
                    For Each col In dt.Columns
                        If col.ColumnName <> "Transfer_Type_Code" And col.ColumnName <> "Transfer Type Name" Then
                            Dim bfield As New TemplateField
                            'Call Function
                            bfield.HeaderTemplate = New ClsOtherServicePriceList(ListItemType.Header, col.ColumnName, fld2)
                            bfield.ItemTemplate = New ClsOtherServicePriceList(ListItemType.Item, col.ColumnName, fld2)
                            grdtransferrates.Columns.Add(bfield)

                        End If

                    Next
                    grdtransferrates.Visible = True
                    grdtransferrates.DataSource = dt
                    'InstantiateIn Grid View
                    grdtransferrates.DataBind()
                End If
            End If
        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("OthPricesList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
    End Sub
#End Region

#Region "Private Sub DisableAllControls()"
    Private Sub DisableAllControls()
        If ViewState("pricelistState") = "New" Then
        ElseIf ViewState("pricelistState") = "Edit" Or ViewState("pricelistState") = "Copy" Then

            If ViewState("pricelistState") = "Edit" Then
                ddlSPType.Disabled = True
                ddlSPTypeName.Disabled = True
            End If

        
            txtRemark.Disabled = False


        ElseIf ViewState("pricelistState") = "Delete" Or ViewState("pricelistState") = "View" Then
         
            txtRemark.Disabled = True
        End If

        'txtCurrCode.Enabled = False
        'txtCurrName.Enabled = False

    End Sub
#End Region




#Region "Private Sub createdatatable()"
    Private Sub createdatatable()
        Try


            Session("GV_OthPLData") = Nothing


            cnt = 0
            strSqlQry = "SELECT  count(dbo.othcatmast.othcatcode) FROM othcatmast  WHERE othgrpcode  in (select option_selected from reservation_parameters where param_id=564) and othcatmast.active=1 "

            cnt = objUtils.ExecuteQueryReturnSingleValuenew(Session("dbconnectionName"), strSqlQry)
            If cnt <= 0 Then
                Session("CheckGridColumn") = "Not Present"
            Else
                Session("CheckGridColumn") = ""
            End If

            ReDim arr(cnt + 1)
            ReDim arrRName(cnt + 1)
            Dim i As Long = 0
            Dim Column As Long = 0

            mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))
            strSqlQry = "SELECT  distinct othcatcode+'-'+options othcatcode, othgrpcode,grporder FROM othcatmast  WHERE othgrpcode in (select option_selected from reservation_parameters where param_id=564)  and othcatmast.active=1 Order by othcatmast.grporder"

            mySqlCmd = New SqlCommand(strSqlQry, mySqlConn)
            mySqlReader = mySqlCmd.ExecuteReader()
            While mySqlReader.Read = True
                arr(Column) = mySqlReader("othcatcode")
                Column = Column + 1
            End While
            mySqlReader.Close()
            mySqlConn.Close()


            'Here in Array store room types
            '-------------------------------------
            Dim tf As New TemplateField
            dt = New DataTable

            dt.Columns.Add(New DataColumn("Transfer_Type_Code", GetType(String)))
            dt.Columns.Add(New DataColumn("Transfer Type Name", GetType(String)))

            'create columns of this room types in data table
            For i = 0 To Column - 1
                dt.Columns.Add(New DataColumn(arr(i), GetType(String)))
            Next


            'Session("GV_HotelData") = dt
            Session("GV_OthPLData") = dt

            For i = grdtransferrates.Columns.Count - 1 To 3 Step -1
                grdtransferrates.Columns.RemoveAt(i)
            Next


            Dim fld2 As String = ""
            Dim col As DataColumn
            For Each col In dt.Columns
                If col.ColumnName <> "Transfer_Type_Code" And col.ColumnName <> "Transfer Type Name" Then


                    Dim bfield As New TemplateField
                    'Call Function
                    bfield.HeaderTemplate = New ClsOtherServicePriceList(ListItemType.Header, col.ColumnName, fld2)
                    bfield.ItemTemplate = New ClsOtherServicePriceList(ListItemType.Item, col.ColumnName, fld2)

                    grdtransferrates.Columns.Add(bfield)


                End If
            Next

            grdtransferrates.Visible = True
            grdtransferrates.DataSource = dt
            grdtransferrates.DataBind()

        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("OthPricesList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        Finally
            clsDBConnect.dbCommandClose(mySqlCmd)
            clsDBConnect.dbReaderClose(mySqlReader)
            clsDBConnect.dbConnectionClose(mySqlConn)
        End Try
    End Sub
#End Region
#Region "Numbers"
    Public Sub Numbers(ByVal txtbox As TextBox)
        Try
            txtbox.Attributes.Add("onkeypress", "return checkNumber()")

        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
        End Try
    End Sub
#End Region
#Region "NumbersInt"
    Public Sub NumbersInt(ByVal txtbox As TextBox)
        Try
            txtbox.Attributes.Add("onkeypress", "return checkNumber1(event)")
        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
        End Try
    End Sub
#End Region
#Region "Private Sub createdatarows()"
    Private Sub createdatarows()
        Dim i As Long
        Dim k As Long = 0
        Try

            strSqlQry = "SELECT  count(othtypmast.othtypcode) FROM  othtypmast  WHERE othgrpcode in (select option_selected from reservation_parameters where param_id=564)  and othtypmast.active=1"
            cnt = objUtils.ExecuteQueryReturnSingleValuenew(Session("dbconnectionName"), strSqlQry)

            Dim arr_rnkorder(cnt + 1) As String
            Dim arr_rows(cnt + 1) As String
            Dim arr_rname(cnt + 1) As String

            mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))
            strSqlQry = "SELECT distinct othtypmast.othtypcode, othtypmast.othtypname,othtypmast.othgrpcode,isnull(rankorder,0) rankorder  FROM othtypmast  WHERE othgrpcode in (select option_selected from reservation_parameters where param_id=564)  and othtypmast.active=1 order by  rankorder"
            mySqlCmd = New SqlCommand(strSqlQry, mySqlConn)
            mySqlReader = mySqlCmd.ExecuteReader()
            While mySqlReader.Read = True
                arr_rows(k) = mySqlReader("othtypcode")
                arr_rname(k) = mySqlReader("othtypname")
                '     arr_rname(k) = mySqlReader("othtypname")
                k = k + 1
            End While
            clsDBConnect.dbReaderClose(mySqlReader)
            clsDBConnect.dbCommandClose(mySqlCmd)
            clsDBConnect.dbConnectionClose(mySqlConn)


            Session("GV_OthPLData") = dt
            Dim dr As DataRow


            dr = Nothing

            Dim row As Long

            For row = 0 To k - 1
                dr = dt.NewRow
              

                dr("Transfer_Type_Code") = arr_rows(row)
                dr("Transfer Type Name") = arr_rname(row)



                'Next
                dt.Rows.Add(dr)
            Next


            grdtransferrates.Visible = True
            grdtransferrates.DataSource = dt
            'InstantiateIn Grid View
            grdtransferrates.DataBind()
        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("OthPriceList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        Finally
            clsDBConnect.dbCommandClose(mySqlCmd)
            clsDBConnect.dbReaderClose(mySqlReader)
            clsDBConnect.dbConnectionClose(mySqlConn)
        End Try
     

    End Sub
#End Region
    Protected Sub chkshft_CheckedChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim chkSelect As CheckBox = CType(sender, CheckBox)
        'Dim row As GridViewRow = CType((CType(sender, CheckBox)).NamingContainer, GridViewRow)
        'Dim lb As Label = CType(row.FindControl("txtctrycode"), Label)


        If chkSelect.Checked = False Then
            Session("shifting") = 0
            lblairport.Text = "Airport Name"
            txtairportname.Text = ""
            txtairportcode.Text = ""
        Else
            Session("shifting") = 1
            lblairport.Text = "Sector Name"
            txtairportname.Text = ""
            txtairportcode.Text = ""
        End If
    End Sub
#Region "Protected Sub btnGenerate_Click(ByVal sender As Object, ByVal e As System.EventArgs)"
    Protected Sub btnGenerate_Click(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim obj As New EncryptionDecryption
        Try

            'If CType(ViewState("OthpricelistState"), String) = "New" Then
            If ValidatePage() = False Then
                Exit Sub
            End If
            'End If

            createdatatable()
            createdatarows()

            btnSave.Style.Add("display", "block")
            btnGenerate.Style.Add("display", "none")
            btnclearprice.Style.Add("display", "block")
            chkapprove.Style.Add("display", "block")
            btncopyrates.Style.Add("display", "block")

          

            Dim shift As String = chkshft.Checked

            '"&SptypeCode=" & ViewState("TransferpricelistRefCode") &
            Session("sessionRemark") = txtRemark.Value
        
        Catch ex As Exception
            objUtils.WritErrorLog("OthPriceList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
    End Sub
#End Region
    <System.Web.Script.Services.ScriptMethod()> _
       <System.Web.Services.WebMethod()> _
    Public Shared Function Getairportlist(ByVal prefixText As String) As List(Of String)

        Dim strSqlQry As String = ""
        Dim myDS As New DataSet
        Dim airportname As New List(Of String)
        Dim shifting As Integer
        Try
            If Not HttpContext.Current.Session("shifting") Is Nothing Then
                shifting = Convert.ToString(HttpContext.Current.Session("shifting").ToString())
            End If

            If shifting = 0 Then
                strSqlQry = "select rtrim(ltrim(airportbordercode)) airportbordercode , rtrim(ltrim(airportbordername)) airportbordername from airportbordersmaster where active=1 and airportbordername like  '" & Trim(prefixText) & "%' order by airportbordername  "
            Else
                strSqlQry = "SELECT distinct othtypmast.othtypcode airportbordercode, othtypmast.othtypname airportbordername FROM othtypmast  WHERE othgrpcode in (select option_selected from reservation_parameters where param_id=564)  and othtypmast.active=1 and othtypname like  '" & Trim(prefixText) & "%' order by  othtypname"
            End If

            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)

            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1

                    airportname.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("airportbordername").ToString(), myDS.Tables(0).Rows(i)("airportbordercode").ToString()))
                    'Hotelnames.Add(myDS.Tables(0).Rows(i)("partyname").ToString() & "<span style='display:none'>" & i & "</span>")
                Next

            End If

            Return airportname
        Catch ex As Exception
            Return airportname
        End Try

    End Function
    Protected Sub btnHelp_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnhelp.Click
        ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "window.open('../Help.aspx?hi=TransPriceListEntry','_blank','status=1,scrollbars=1,top=135,left=760,width=250,height=500');", True)
    End Sub
    <System.Web.Script.Services.ScriptMethod()> _
  <System.Web.Services.WebMethod()> _
    Public Shared Function Getcurrlist(ByVal prefixText As String) As List(Of String)

        Dim strSqlQry As String = ""
        Dim myDS As New DataSet
        Dim currname As New List(Of String)
        Try

            strSqlQry = "select currcode,currname  from  currmast where active=1 and convrate <>0  and currname like  '" & Trim(prefixText) & "%' order by currname "

            '   strSqlQry = "select rtrim(ltrim(othgrpcode))othgrpcode,rtrim(ltrim(othgrpname))othgrpname from othgrpmast where  " _
            '      & " othmaingrpcode in(select option_selected from reservation_parameters where param_id in (1104,1105)) and active=1 and othgrpname like '" & Trim(prefixText) & "%' order by othgrpname"
            Dim SqlConn As New SqlConnection
            Dim myDataAdapter As New SqlDataAdapter
            ' SqlConn = clsDBConnect.dbConnectionnew(objclsConnectionName.ConnectionName)
            SqlConn = clsDBConnect.dbConnectionnew("strDBConnection")
            'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, SqlConn)
            myDataAdapter.Fill(myDS)

            If myDS.Tables(0).Rows.Count > 0 Then
                For i As Integer = 0 To myDS.Tables(0).Rows.Count - 1

                    currname.Add(AjaxControlToolkit.AutoCompleteExtender.CreateAutoCompleteItem(myDS.Tables(0).Rows(i)("currname").ToString(), myDS.Tables(0).Rows(i)("currcode").ToString()))

                Next

            End If

            Return currname
        Catch ex As Exception
            Return currname
        End Try

    End Function

#Region "Protected Sub btnCancel_Click(ByVal sender As Object, ByVal e As System.EventArgs)"
    Protected Sub btnCancel_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnCancel.Click
        Session("sessionRemark") = Nothing
        Session("GV_OthHotelData") = Nothing
        ViewState("RefCode") = Nothing
        ViewState("pricelistState") = Nothing
        ' Response.Redirect("OtherServicesCostPriceListSearch.aspx")
        ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "popup", "window.close();", True)
    End Sub
#End Region
    Private Sub ShowDates(ByVal RefCode As String)
        Try



            Dim strSqlQry As String = ""
            Dim cnt As Integer = 0


            strSqlQry = "select count( distinct frmdate) from trfplist_dates(nolock) where tplistcode='" & RefCode & "'" '" ' and subseasnname = '" & subseasonname & "'"
            cnt = objUtils.ExecuteQueryReturnSingleValuenew(Session("dbconnectionName"), strSqlQry)
            If cnt = 0 Then cnt = 1
            fillDategrd(grdDates, False, cnt)

            Dim gvRow As GridViewRow
            Dim dpFDate As TextBox
            Dim dpTDate As TextBox
            mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))           'connection open            
            mySqlCmd = New SqlCommand("Select * from trfplist_dates(nolock) Where tplistcode='" & RefCode & "'", mySqlConn)
            mySqlReader = mySqlCmd.ExecuteReader(CommandBehavior.CloseConnection)
            If mySqlReader.HasRows Then
                While mySqlReader.Read()
                    For Each gvRow In grdDates.Rows
                        dpFDate = gvRow.FindControl("txtfromdate")
                        dpTDate = gvRow.FindControl("txttodate")
                        '     Dim lblseason As Label = gvRow.FindControl("lblseason")
                        If dpFDate.Text = "" And dpFDate.Text = "" Then
                            If IsDBNull(mySqlReader("frmdate")) = False Then
                                dpFDate.Text = CType(Format(CType(mySqlReader("frmdate"), Date), "dd/MM/yyyy"), String)

                            End If
                            If IsDBNull(mySqlReader("todate")) = False Then
                                dpTDate.Text = CType(Format(CType(mySqlReader("todate"), Date), "dd/MM/yyyy"), String)
                            End If

                            Exit For
                        End If
                    Next
                End While
            End If
            '  txtseasonname.Enabled = False


        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("Othpricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        Finally
            ' clsDBConnect.dbAdapterClose(myDataAdapter)                       'Close adapter
            'clsDBConnect.dbConnectionClose(SqlConn)                          'Close connection  
            clsDBConnect.dbCommandClose(mySqlCmd)               'sql command disposed
            clsDBConnect.dbReaderClose(mySqlReader)             ' sql reader disposed    
            clsDBConnect.dbConnectionClose(mySqlConn)           'connection close   
        End Try
    End Sub
    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load

        Dim RefCode As String
        Try
            If IsPostBack() = False Then

                ViewState.Add("pricelistState", Request.QueryString("State"))
                ViewState.Add("RefCode", Request.QueryString("RefCode"))

                btnSave.Style.Add("display", "none")
                btnGenerate.Style.Add("display", "block")

                wucCountrygroup.sbSetPageState("", "TRFPLIST", CType(ViewState("pricelistState"), String))


                RefCode = CType(ViewState("RefCode"), String)

                hdndecimal.Value = objUtils.ExecuteQueryReturnSingleValuenew(Session("dbconnectionName"), "select option_selected from reservation_parameters(nolock) where param_id=1140")

                If CType(ViewState("pricelistState"), String) = "New" Then


                    Session("isAutoTick_wuccountrygroupusercontrol") = 1
                    wucCountrygroup.sbShowCountry()

                    txtApplicableTo.Focus()

                    chkapprove.Style.Add("display", "none")
                    btncopyrates.Style.Add("display", "none")
                    btnclearprice.Style.Add("display", "none")
                ElseIf CType(ViewState("pricelistState"), String) = "Copy" Then
                    ShowRecord(RefCode)
                    wucCountrygroup.sbSetPageState(RefCode, Nothing, CType(ViewState("pricelistState"), String))
                    wucCountrygroup.sbShowCountry()

                    ShowDates(CType(RefCode, String))
                    createdatatable()
                    createdatarows()
                    ShowDynamicGridnew(CType(RefCode, String))
                    txtPlcCode.Value = ""
                    btnGenerate.Style.Add("display", "none")
                    btnSave.Style.Add("display", "block")
                    chkapprove.Style.Add("display", "block")
                    btncopyrates.Style.Add("display", "block")
                    btnclearprice.Style.Add("display", "block")
                ElseIf CType(ViewState("pricelistState"), String) = "Edit" Then

                    btnSave.Text = "Update"

                    RefCode = CType(ViewState("RefCode"), String)
                    ShowRecord(RefCode)
                    ShowDates(CType(RefCode, String))
                    createdatatable()
                    createdatarows()
                    ShowDynamicGridnew(CType(RefCode, String))
                 

                    wucCountrygroup.sbSetPageState(RefCode, Nothing, CType(ViewState("pricelistState"), String))
                    wucCountrygroup.sbShowCountry()

                    btnGenerate.Style.Add("display", "none")
                    btnSave.Style.Add("display", "block")
                    btnSave.Text = "Update"
                    chkapprove.Style.Add("display", "block")
                    btncopyrates.Style.Add("display", "block")
                    btnclearprice.Style.Add("display", "block")

                ElseIf CType(ViewState("pricelistState"), String) = "View" Then

                    RefCode = CType(ViewState("RefCode"), String)

                    ShowRecord(RefCode)
                    ShowDates(CType(RefCode, String))
                    createdatatable()
                    createdatarows()
                    ShowDynamicGridnew(CType(RefCode, String))

                    wucCountrygroup.sbSetPageState(RefCode, Nothing, CType(ViewState("pricelistState"), String))
                    wucCountrygroup.sbShowCountry()

                    btnGenerate.Style.Add("display", "none")
                    btnSave.Style.Add("display", "none")
                    chkapprove.Style.Add("display", "block")
                    btncopyrates.Style.Add("display", "block")
                    btnclearprice.Style.Add("display", "block")


                ElseIf CType(ViewState("pricelistState"), String) = "Delete" Then

                    RefCode = CType(ViewState("RefCode"), String)

                    ShowRecord(RefCode)
                    ShowDates(CType(RefCode, String))
                    createdatatable()
                    createdatarows()
                    ShowDynamicGridnew(CType(RefCode, String))

                    wucCountrygroup.sbSetPageState(RefCode, Nothing, CType(ViewState("pricelistState"), String))
                    wucCountrygroup.sbShowCountry()

                    btnGenerate.Style.Add("display", "none")
                    btnSave.Style.Add("display", "block")
                    btnSave.Text = "Delete"
                    chkapprove.Style.Add("display", "block")
                    btncopyrates.Style.Add("display", "block")
                    btnclearprice.Style.Add("display", "block")
                End If

                DisableAllControls()

            Else


            End If
        Catch ex As Exception
            objUtils.WritErrorLog("OthPriceList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try

    End Sub

    Private Sub ShowDynamicGridnew(ByVal RefCode As String)
        Dim j As Long = 0
        Dim txt As TextBox
        Dim cnt As Long = 0
        Dim gvrow As GridViewRow
        Dim srno As Long = 0
        Dim hotelcategory As String = ""
        grdtransferrates.Visible = True
        cnt = grdtransferrates.Columns.Count
        Dim s As Long = 0
        Dim header As Long = 0
        Dim heading(cnt + 1) As String
        For header = 0 To cnt - 4
            txt = grdtransferrates.HeaderRow.FindControl("txtHead" & header)
            If txt.Text <> Nothing Then
                heading(header) = txt.Text
            End If
        Next
        Dim m As Long = 0
        Dim rmcatcode As String = ""
        Dim value As String = ""
        Dim Linno As Integer
        Dim rmtypecode As String = ""
        Dim mealcode As String = ""
        Dim StrQry As String
        Dim headerlabel As New TextBox
        Dim myConn As New SqlConnection
        Dim myCmd As New SqlCommand
        Dim myReader As SqlDataReader
        Dim StrQryTemp As String
        Dim txttrftypecode As TextBox
        Dim sectorcode As String
        Try
            '    Dim extrapx As String = objUtils.ExecuteQueryReturnStringValuenew(Session("dbconnectionName"), "select option_selected from reservation_parameters where param_id=1139")


            StrQry = "select distinct trfplist_detail.sectorcode from trfplist_detail where trfplist_detail.tplistcode = '" & RefCode & "'"



            mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))
            mySqlCmd = New SqlCommand(StrQry, mySqlConn)
            mySqlReader = mySqlCmd.ExecuteReader()
            If mySqlReader.HasRows Then
                While mySqlReader.Read
                    For Each gvrow In grdtransferrates.Rows

                        txttrftypecode = gvrow.FindControl("txttrftypecode")
                      
                        If IsDBNull(mySqlReader("sectorcode")) = False Then
                            sectorcode = mySqlReader("sectorcode")
                        End If
                        If txttrftypecode Is Nothing = False Then

                            StrQryTemp = "select trfplist_detail.tplistcode  ,trfplist_detail.sectorcode,trfplist_detail.othgrpcode,trfplist_detail.cartype, " & _
              " trfplist_detail.price,trfplist_detail.pkg from  trfplist_detail  " & _
              " where   " & _
              " trfplist_detail.tplistcode= '" & RefCode & "' and sectorcode = '" & txttrftypecode.Text & "'"



                            myConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))
                            myCmd = New SqlCommand(StrQryTemp, myConn)
                            myReader = myCmd.ExecuteReader
                            If myReader.HasRows Then
                                While myReader.Read
                                    If IsDBNull(myReader("cartype")) = False Then
                                        rmcatcode = myReader("cartype")
                                    End If
                                    If IsDBNull(myReader("price")) = False Then
                                        value = (myReader("price"))
                                    Else
                                        value = ""
                                    End If

                                    For j = 0 To cnt - 4
                                        'If heading(j) = "Min Nights" Or heading(j) = "No.of.Nights Room Rate" Or heading(j) = "Unityesno" Or heading(j) = "Unityesno" Or heading(j) = "Noofextraperson" Then
                                        'Else
                                        For s = 0 To grdtransferrates.Columns.Count - 4
                                            headerlabel = grdtransferrates.HeaderRow.FindControl("txtHead" & s)
                                            Dim arrlist As String()
                                            If headerlabel.Text <> Nothing Then
                                                arrlist = headerlabel.Text.Split("-")
                                                If ((arrlist(0) = rmcatcode)) Then
                                                    If gvrow.RowIndex = 0 Then
                                                        txt = gvrow.FindControl("txt" & s)
                                                    Else
                                                        txt = gvrow.FindControl("txt" & ((grdtransferrates.Columns.Count - 4) * gvrow.RowIndex) + s + gvrow.RowIndex)
                                                    End If
                                                    If txt Is Nothing Then
                                                    Else
                                                        If value = "" Then
                                                            txt.Text = ""
                                                        Else
                                                            Select Case value
                                                                Case "-4"
                                                                    value = "N/A"
                                                                Case "-5"
                                                                    value = "On Request"
                                                            End Select
                                                            If txt.Enabled = True Then
                                                                txt.Text = Math.Round(Val(value), 2) 'DecRound(value)
                                                                ' txt.Text = value
                                                            End If

                                                        End If
                                                    End If
                                                    GoTo go1
                                                End If
                                            End If
                                        Next
                                        'End If
                                    Next
go1:                            End While
                            End If
                            clsDBConnect.dbConnectionClose(myConn)
                            clsDBConnect.dbCommandClose(myCmd)
                            clsDBConnect.dbReaderClose(myReader)
                            ' End If '''
                        End If
                    Next
                End While
            End If
            clsDBConnect.dbConnectionClose(mySqlConn)
            clsDBConnect.dbCommandClose(mySqlCmd)
            clsDBConnect.dbReaderClose(mySqlReader)

        Catch ex As Exception
            objUtils.WritErrorLog("Othpricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
            clsDBConnect.dbConnectionClose(mySqlConn)
        End Try
    End Sub
    Protected Sub btnclearprice_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnclearprice.Click
        Dim j As Long = 1
        Dim txt As TextBox
        Dim cnt As Long
        Dim GvRow As GridViewRow

        Dim srno As Long = 0
        Dim hotelcategory As String = ""
        j = 0
        grdtransferrates.Visible = True
        cnt = grdtransferrates.Columns.Count
        Dim n As Long = 0
        Dim k As Long = 0

        Dim header As Long = 0
        Dim heading(cnt + 1) As String
        Try
            For header = 0 To cnt - 4
                txt = grdtransferrates.HeaderRow.FindControl("txtHead" & header)
                heading(header) = txt.Text
            Next
        Catch ex As Exception
            objUtils.WritErrorLog("OthPricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
        Dim arr_room(header + 1) As String
        Dim m As Long = 0
        Dim a As Long = cnt - 10
        Dim b As Long = 0

        Dim chk As HtmlInputCheckBox
        Dim cnt_checked As Long
        'Dim GvRow1 As GridViewRow
        Try



            Dim arr(3) As String
            Dim arr_pkg(3) As String
            Dim arr_cancdays(3) As String

            Dim room As Long = 0
            Dim row_id As Long
            Dim pkg As Long = 0

            For Each GvRow In grdtransferrates.Rows
                chk = GvRow.FindControl("ChkSelect")
                If n = 0 Then
                    For j = 0 To cnt - 4
                        'If chk.Checked = True Then
                        row_id = GvRow.RowIndex
                        'If heading(j) = "Min Nights" Or heading(j) = "No.of.Nights Room Rate" Or heading(j) = "Unityesno" Or heading(j) = "Extra Person Supplement" Or heading(j) = "Unityesno" Or heading(j) = "Noofextraperson" Then
                        'Else

                        txt = GvRow.FindControl("txt" & j)
                        If txt Is Nothing Then
                        Else
                            If txt.Text <> Nothing Then
                                ' arr_room(room) = txt.Text
                                txt.Text = ""
                            End If
                        End If
                        pkg = pkg + 1
                        room = room + 1
                        ' End If
                        'End If '''
                    Next

                    m = j
                    'a = j
                Else
                    k = 0
                    pkg = 0
                    For j = n To (m + n) - 1
                        ' If chk.Checked = True Then
                        row_id = GvRow.RowIndex
                        'If heading(k) = "Min Nights" Or heading(k) = "No.of.Nights Room Rate" Or heading(k) = "Unityesno" Or heading(k) = "Extra Person Supplement" Or heading(k) = "Unityesno" Or heading(k) = "Noofextraperson" Then
                        'Else

                        txt = GvRow.FindControl("txt" & j)
                        If txt Is Nothing Then
                        Else
                            If txt.Text <> Nothing Then
                                'arr_room(room) = txt.Text
                                txt.Text = ""
                            End If
                        End If
                        pkg = pkg + 1
                        room = room + 1
                        '   End If
                        'End If ''''
                        k = k + 1
                    Next

                End If

                b = j
                n = j
            Next
        Catch ex As Exception
            objUtils.WritErrorLog("Othpricelist1[pplements.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))

        End Try
    End Sub
    Protected Sub btncopyrates_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btncopyrates.Click
        Dim j As Long = 1
        Dim txt As TextBox
        Dim cnt As Long
        Dim GvRow As GridViewRow

        Dim srno As Long = 0
        Dim hotelcategory As String = ""
        j = 0
        grdtransferrates.Visible = True
        cnt = grdtransferrates.Columns.Count
        Dim n As Long = 0
        Dim k As Long = 0

        Dim header As Long = 0
        Dim heading(cnt + 1) As String
        Try
            For header = 0 To cnt - 4
                txt = grdtransferrates.HeaderRow.FindControl("txtHead" & header)
                heading(header) = txt.Text
            Next
        Catch ex As Exception
            objUtils.WritErrorLog("OthPricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
        Dim arr_room(header + 1) As String
        Dim m As Long = 0
        Dim a As Long = cnt - 10
        Dim b As Long = 0

        Dim chk As HtmlInputCheckBox
        Dim cnt_checked As Long
        'Dim GvRow1 As GridViewRow
        Try
            For Each GvRow In grdtransferrates.Rows
                chk = GvRow.FindControl("ChkSelect")
                If chk.Checked = True Then
                    cnt_checked = cnt_checked + 1
                End If
            Next
            If cnt_checked = 0 Then
                ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Select at least one row');", True)
                SetFocus(cnt_checked)
                Exit Sub
            End If


            Dim arr(3) As String
            Dim arr_pkg(3) As String
            Dim arr_cancdays(3) As String

            Dim room As Long = 0
            Dim row_id As Long
            Dim pkg As Long = 0

            For Each GvRow In grdtransferrates.Rows
                chk = GvRow.FindControl("ChkSelect")
                If n = 0 Then
                    For j = 0 To cnt - 4
                        If chk.Checked = True Then
                            row_id = GvRow.RowIndex
                            'If heading(header) = "Min Nights" Or heading(header) = "No.of.Nights Room Rate" Or heading(header) = "Unityesno" Or heading(header) = "Extra Person Supplement" Or heading(header) = "Unityesno" Or heading(header) = "Noofextraperson" Then
                            'Else

                            txt = GvRow.FindControl("txt" & j)
                            If txt Is Nothing Then
                            Else
                                If txt.Text <> Nothing Then
                                    arr_room(room) = txt.Text
                                End If
                            End If
                            pkg = pkg + 1
                            room = room + 1
                        End If
                        'End If
                    Next

                    m = j
                    'a = j
                Else
                    k = 0
                    pkg = 0
                    For j = n To (m + n) - 1
                        If chk.Checked = True Then
                            row_id = GvRow.RowIndex
                            'If heading(header) = "Min Nights" Or heading(header) = "No.of.Nights Room Rate" Or heading(header) = "Unityesno" Or heading(header) = "Extra Person Supplement" Or heading(header) = "Unityesno" Or heading(header) = "Noofextraperson" Then
                            'Else

                            txt = GvRow.FindControl("txt" & j)
                            If txt Is Nothing Then
                            Else
                                If txt.Text <> Nothing Then
                                    arr_room(room) = txt.Text
                                End If
                            End If
                            pkg = pkg + 1
                            room = room + 1
                            ' End If
                        End If
                        k = k + 1
                    Next

                End If

                b = j
                n = j
            Next
            '--------------------------------------------------------------------------------------------
            'Noe Fill Record to Cell
            room = 0
            pkg = 0
            n = 0
            b = 0

            For Each GvRow In grdtransferrates.Rows
                chk = GvRow.FindControl("ChkSelect")
                If n = 0 Then
                    For j = 0 To cnt - 4
                        If GvRow.RowIndex = row_id + 1 Then
                            'If heading(header) = "Min Nights" Or heading(header) = "No.of.Nights Room Rate" Or heading(header) = "Unityesno" Or heading(header) = "Extra Person Supplement" Or heading(header) = "Unityesno" Or heading(header) = "Noofextraperson" Then
                            'Else


                            txt = GvRow.FindControl("txt" & j)
                            If txt Is Nothing Then
                            Else
                                If txt.Enabled = True Then
                                    txt.Text = arr_room(room)
                                End If
                            End If


                            room = room + 1
                            ' End If
                        End If
                    Next
                    m = j
                Else
                    k = 0
                    For j = n To (m + n) - 1
                        If GvRow.RowIndex = row_id + 1 Then
                            'If heading(header) = "Min Nights" Or heading(header) = "No.of.Nights Room Rate" Or heading(header) = "Unityesno" Or heading(header) = "Extra Person Supplement" Or heading(header) = "Unityesno" Or heading(header) = "Noofextraperson" Then
                            'Else

                            txt = GvRow.FindControl("txt" & j)
                            If txt Is Nothing Then
                            Else
                                If txt.Enabled = True Then
                                    txt.Text = arr_room(room)
                                End If
                            End If


                            room = room + 1
                            ' End If
                        End If
                        k = k + 1
                    Next
                End If
                b = j
                n = j
            Next
        Catch ex As Exception
            objUtils.WritErrorLog("OthPricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))

        End Try
    End Sub
#Region "Private Sub ShowDynamicGrid()"

    Private Sub ShowDynamicGrid(ByVal RefCode As String)
        Try
            cnt = 0
            Dim StrQry As String = ""

            '--------------------------------------------------------
            ' Show Records From Details Table 
            Dim GVROW As GridViewRow
            cnt = grdtransferrates.Columns.Count - 2
            Dim i As Long = 0
            'Dim n As Long = 0
            'Dim m As Long = 0
            Dim txt1 As TextBox
            Dim header As Long = 0
            Dim heading(cnt + 1) As String

            Dim othcatcode As String
            Dim value As String

            Dim Linno As Integer
            Dim StrQryTemp As String = ""
            Dim myConn As New SqlConnection
            Dim myCmd As New SqlCommand
            Dim myReader As SqlDataReader
            Dim j As Long = 0
            Dim s As Long

            Try
                For header = 0 To cnt - 2
                    txt1 = grdtransferrates.HeaderRow.FindControl("txtHead" & header)
                    heading(header) = txt1.Text
                   
                Next
            Catch ex As Exception
                ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            End Try





            StrQry = "select distinct trfplist_detail.sectorcode from trfplist_detail where trfplist_detail.tplistcode = '" & RefCode & "'"

            Dim txt As TextBox
            Dim headerlabel As New TextBox
            mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))
            mySqlCmd = New SqlCommand(StrQry, mySqlConn)
            mySqlReader = mySqlCmd.ExecuteReader()

            Dim txttrftypecode As TextBox

            For Each GVROW In grdtransferrates.Rows

                txttrftypecode = GVROW.FindControl("txttrftypecode")

                StrQryTemp = "select trfplist_detail.tplistcode  ,trfplist_detail.sectorcode,trfplist_detail.othgrpcode,trfplist_detail.cartype, " & _
  " trfplist_detail.price,trfplist_detail.pkg from  trfplist_detail  " & _
  " where   " & _
  " trfplist_detail.tplistcode= '" & RefCode & "' and sectorcode = '" & txttrftypecode.Text & "'"

                myConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))
                myCmd = New SqlCommand(StrQryTemp, myConn)
                myReader = myCmd.ExecuteReader
                If myReader.HasRows Then
                    While myReader.Read
                        othcatcode = myReader("cartype")

                        If IsDBNull(myReader("price")) = False Then
                            value = myReader("price")
                        Else
                            value = ""
                        End If
                        For j = 0 To cnt - 2
                            'If heading(i) = "From Date" Or heading(i) = "To Date" Or heading(i) = "Pkg" Then
                            'Else
                            For s = 0 To grdtransferrates.Columns.Count - 4
                                Dim arrlist As String()
                                headerlabel = grdtransferrates.HeaderRow.FindControl("txtHead" & s)
                                If headerlabel.Text <> Nothing Then
                                    arrlist = heading(j).Split("-")
                                    If arrlist(0) = othcatcode Then
                                        If GVROW.RowIndex = 0 Then
                                            txt = GVROW.FindControl("txt" & s)
                                        Else
                                            txt = GVROW.FindControl("txt" & ((grdtransferrates.Columns.Count - 4) * GVROW.RowIndex) + s + GVROW.RowIndex)
                                        End If
                                        If txt Is Nothing Then
                                        Else
                                            If value = "" Then
                                                txt.Text = ""
                                            Else
                                                txt.Text = value
                                            End If
                                        End If
                                      
                                        GoTo go1
                                    End If
                                End If
                            Next
                            ' End If

                        Next
go1:                End While
                End If
                clsDBConnect.dbConnectionClose(myConn)
                clsDBConnect.dbCommandClose(myCmd)
                clsDBConnect.dbReaderClose(myReader)
                ' End If
            Next
            '    End While
            'End If


            clsDBConnect.dbConnectionClose(mySqlConn)
            clsDBConnect.dbCommandClose(mySqlCmd)
            clsDBConnect.dbReaderClose(mySqlReader)
        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & ex.Message & " ');", True)
        End Try

    End Sub
#End Region
    'Protected Sub btnhelp_Click(ByVal sender As Object, ByVal e As System.EventArgs)
    '    ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "window.open('../Help.aspx?hi=OthPriceList1','_blank','status=1,scrollbars=1,top=135,left=760,width=250,height=500');", True)
    'End Sub

    Protected Sub Page_LoadComplete(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.LoadComplete

    End Sub

    Public Sub New()

    End Sub

    Protected Sub btnselect_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnselect.Click
        Fillairports()
        ModalSelectairport.Show()
    End Sub

    Private Sub Fillairports()
        Try


            Dim dt As New DataTable
            Dim strSqlQry As String = ""




            '''''''''''


            Dim myDS As New DataSet



            If chkshft.Checked = True Then
                Label3.Text = "Sector Selection"
                strSqlQry = "SELECT distinct othtypmast.othtypcode airportbordercode, othtypmast.othtypname airportbordername FROM othtypmast  WHERE othgrpcode in (select option_selected from reservation_parameters where param_id=564)  and othtypmast.active=1  order by  othtypname"
            Else
                Label3.Text = "Airport Selection"
                strSqlQry = "select rtrim(ltrim(airportbordercode)) airportbordercode , rtrim(ltrim(airportbordername)) airportbordername from airportbordersmaster where active=1  order by airportbordername  "
            End If


            mySqlConn = clsDBConnect.dbConnectionnew(Session("dbconnectionName"))                             'Open connection
            myDataAdapter = New SqlDataAdapter(strSqlQry, mySqlConn)
            myDataAdapter.Fill(myDS)
            gvSelectAirport.DataSource = myDS


            If myDS.Tables(0).Rows.Count > 0 Then

                gvSelectAirport.DataBind()

            Else
                gvSelectAirport.PageIndex = 0
                gvSelectAirport.DataBind()

            End If



            ChkExistingValdiscount(hdnairport.Value)


        Catch ex As Exception
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & "Error Description " + ex.Message.Replace("'", " ") & "' );", True)
            objUtils.WritErrorLog("OthPricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
    End Sub

    Private Sub ChkExistingValdiscount(ByVal prm_strChkdVal As String)


        Dim arrString As String()
        Dim arrlist As String()
        Dim j As Integer = 0 'string in the form "a,b;c,d;...."

        If prm_strChkdVal <> "" Then
            arrString = prm_strChkdVal.Split(",") 'spliting for ';' 1st



            For k = 0 To arrString.Length - 1
                If arrString(k) <> "" Then

                    'Dim arrAdultChild As String() = arrString(k).Split("/") 'spliting for ',' 2nd

                    For Each grdRow In gvSelectAirport.Rows
                        Dim chkairportSelect As CheckBox = CType(grdRow.FindControl("chkairportSelect"), CheckBox)
                        Dim lblairportcode As Label = grdRow.FindControl("lblairportcode")



                        If (arrString(k) = lblairportcode.Text) Then
                            chkairportSelect.Checked = True

                        End If

                    Next
                End If
            Next


        End If
    End Sub

    Protected Sub btnokairport_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnokairport.Click
        Dim applies As String = ""
        Dim tickedornot As Boolean
        tickedornot = False
        For Each grdRow In gvSelectAirport.Rows
            Dim chkairportSelect As CheckBox = CType(grdRow.FindControl("chkairportSelect"), CheckBox)
            chkairportSelect = grdRow.FindControl("chkairportSelect")
            If chkairportSelect.Checked = True Then
                tickedornot = True
                Exit For
            End If
        Next

        If tickedornot = False Then
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Please select any ');", True)
            ModalSelectairport.Show()
            Exit Sub
        End If
        txtairportname.Text = ""

        For Each grdRow In gvSelectAirport.Rows
            Dim chkairportSelect As CheckBox = CType(grdRow.FindControl("chkairportSelect"), CheckBox)
            Dim lblairportcode As Label = grdRow.FindControl("lblairportcode")

            If chkairportSelect.Checked = True Then
                If lblairportcode.Text <> "" Then
                    applies = applies + "," + lblairportcode.Text
                    txtairportname.Text = txtairportname.Text + "," + grdRow.cells(2).text
                End If


            End If
        Next

        If applies.Length > 0 Then
            hdnairport.Value = Right(applies, Len(applies) - 1)
            txtairportcode.Text = hdnairport.Value
            txtairportname.Text = Right(txtairportname.Text, Len(txtairportname.Text) - 1)
        End If

        ModalSelectairport.Hide()
    End Sub
    Public Sub SetDate()
        Try
            Dim gvRow As GridViewRow
            Dim flgdt As Boolean = False
            Dim tempFrmDt As String = ""
            Dim tempToDt As String = ""
            ViewState("TempFrmDt") = ""
            ViewState("TempToDt") = ""
            For Each gvRow In grdDates.Rows
                dpFDate = gvRow.FindControl("txtfromDate")
                dpTDate = gvRow.FindControl("txttoDate")
                If dpFDate.Text <> "" And dpTDate.Text <> "" Then
                    If flgdt = False Then
                        'dpFromdate.txtDate.Text = dpFDate.txtDate.Text
                        tempFrmDt = dpFDate.Text
                        tempToDt = dpTDate.Text
                    Else
                        If CType(dpFDate.Text, Date) < CType(tempFrmDt, Date) Then
                            tempFrmDt = CType(dpFDate.Text, Date)
                        End If

                        If CType(dpTDate.Text, Date) > CType(tempToDt, Date) Then
                            tempToDt = CType(dpTDate.Text, Date)
                        End If
                    End If
                    flgdt = True
                End If
            Next
            ViewState("TempFrmDt") = tempFrmDt
            ViewState("TempToDt") = tempToDt


        Catch ex As Exception
            objUtils.WritErrorLog("OthPriceList1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try
    End Sub
    Public Function DecRound(ByVal Ramt As Decimal) As Decimal
        Dim Rdamt As Decimal

        Rdamt = Math.Round(Val(Ramt), CType(hdndecimal.Value, Integer))
        Return Rdamt
    End Function
    Public Function FindDatePeriod() As Boolean
        Dim GVRow As GridViewRow



        Dim strMsg As String = ""

        FindDatePeriod = True
        Try

            '   CopyRow = 0
            Dim chksel As CheckBox
            Dim weekdaystr As String = ""


         

            Session("CountryList") = Nothing
            Session("AgentList") = Nothing

            Session("CountryList") = wucCountrygroup.checkcountrylist
            Session("AgentList") = wucCountrygroup.checkagentlist


          
            For Each GVRow In grdDates.Rows

                Dim txtfromdate As TextBox = GVRow.FindControl("txtfromdate")
                Dim txttodate As TextBox = GVRow.FindControl("txttodate")

                If txtfromdate.Text <> "" And txttodate.Text <> "" Then

                    Dim ds1 As DataSet
                    Dim parms3 As New List(Of SqlParameter)
                    Dim parm3(7) As SqlParameter

                    parm3(0) = New SqlParameter("@airportcode", IIf(chkshft.Checked = False, CType(txtairportcode.Text, String), ""))
                    parm3(1) = New SqlParameter("@sectorcode", IIf(chkshft.Checked = True, CType(txtairportcode.Text, String), ""))
                    parm3(2) = New SqlParameter("@fromdate", Format(CType(txtfromdate.Text, Date), "yyyy/MM/dd"))
                    parm3(3) = New SqlParameter("@todate", Format(CType(txttodate.Text, Date), "yyyy/MM/dd"))
                    parm3(4) = New SqlParameter("@plistcode", CType(txtPlcCode.Value, String))
                    parm3(5) = New SqlParameter("@country", CType(Session("CountryList"), String))
                    parm3(6) = New SqlParameter("@agent", CType(Session("AgentList"), String))



                    For i = 0 To 6
                        parms3.Add(parm3(i))
                    Next

                    ds1 = New DataSet()
                    ds1 = objUtils.ExecuteQuerynew(Session("dbconnectionName"), "sp_chkduplicate_Trfplist", parms3)


                    If ds1.Tables.Count > 0 Then
                        If ds1.Tables(0).Rows.Count > 0 Then
                            If IsDBNull(ds1.Tables(0).Rows(0)("tplistcode")) = False Then
                                strMsg = "Transfer Pricelist already exists For this   " + ds1.Tables(0).Rows(0)("tplistcode") + " - Country " + ds1.Tables(0).Rows(0)("ctryname") + " - Agent - " + ds1.Tables(0).Rows(0)("agentname")
                                ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('" & strMsg & "' );", True)
                                FindDatePeriod = False
                                Exit Function
                            End If
                        End If
                    End If

                End If
            Next



        Catch ex As Exception
            FindDatePeriod = False
            ScriptManager.RegisterClientScriptBlock(Page, GetType(Page), "", "alert('Error Description: - " & ex.Message & "');", True)
            objUtils.WritErrorLog("OthPricelist1.aspx", Server.MapPath("ErrorLog.txt"), ex.Message.ToString, Session("GlobalUserName"))
        End Try


    End Function
    

    Protected Sub gvSelectAirport_PageIndexChanging(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewPageEventArgs) Handles gvSelectAirport.PageIndexChanging
        gvSelectAirport.PageIndex = e.NewPageIndex
        Fillairports()
        ModalSelectairport.Show()
    End Sub
End Class
